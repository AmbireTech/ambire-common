{"version":3,"file":"PaymasterFactory.js","sourceRoot":"","sources":["../../../../src/services/paymaster/PaymasterFactory.ts"],"names":[],"mappings":";;;AAKA,8DAA0D;AAC1D,oEAAgE;AAEhE,yDAAqD;AAErD,2CAA2C;AAC3C,qEAAqE;AACrE,qDAAqD;AACrD,oEAAoE;AACpE,kCAAkC;AAClC,MAAa,gBAAgB;IAC3B,WAAW,GAAyB,SAAS,CAAA;IAE7C,aAAa,GAAyB,SAAS,CAAA;IAE/C,IAAI,CAAC,UAAkB,EAAE,KAAY,EAAE,aAAuB;QAC5D,IAAI,CAAC,WAAW,GAAG,yBAAW,CAAC,IAAI,CAAC,EAAE,GAAG,EAAE,UAAU,EAAE,KAAK,EAAE,CAAC,CAAA;QAC/D,IAAI,CAAC,aAAa,GAAG,aAAa,CAAA;IACpC,CAAC;IAED,KAAK,CAAC,MAAM,CACV,EAAa,EACb,MAAqB,EACrB,OAAgB,EAChB,QAAqB;QAErB,IAAI,IAAI,CAAC,WAAW,KAAK,SAAS,IAAI,IAAI,CAAC,aAAa,KAAK,SAAS;YACpE,MAAM,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAA;QAEpC,0DAA0D;QAC1D,wDAAwD;QACxD,MAAM,OAAO,GAAG,EAAE,GAAG,EAAE,EAAE,CAAA;QACzB,MAAM,kBAAkB,GAAG,EAAE,CAAC,IAAI,EAAE,gBAAgB,EAAE,EAAE,CAAA;QACxD,IAAI,kBAAkB,IAAI,mCAAgB,CAAC,oBAAoB,CAAC,kBAAkB,CAAC,EAAE;YACnF,IAAI,OAAO,CAAC,IAAI,IAAI,OAAO,CAAC,IAAI,CAAC,gBAAgB;gBAAE,OAAO,CAAC,IAAI,CAAC,gBAAgB,CAAC,MAAM,GAAG,IAAI,CAAA;SAC/F;QAED,MAAM,SAAS,GAAG,IAAI,qBAAS,CAAC,IAAI,CAAC,WAAW,EAAE,IAAI,CAAC,aAAa,CAAC,CAAA;QACrE,MAAM,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,QAAQ,CAAC,CAAA;QACxD,OAAO,SAAS,CAAA;IAClB,CAAC;CACF;AA/BD,4CA+BC","sourcesContent":["import { Fetch } from '../../interfaces/fetch'\nimport { Network } from '../../interfaces/network'\nimport { RPCProvider } from '../../interfaces/provider'\nimport { AccountOp } from '../../libs/accountOp/accountOp'\nimport { AbstractPaymaster } from '../../libs/paymaster/abstractPaymaster'\nimport { Paymaster } from '../../libs/paymaster/paymaster'\nimport { relayerCall } from '../../libs/relayerCall/relayerCall'\nimport { UserOperation } from '../../libs/userOperation/types'\nimport { failedPaymasters } from './FailedPaymasters'\n\n// a factory for creating paymaster objects\n// this is needed as we'd like to create paymasters at will with easy\n// access to app properties like relayerUrl and Fetch\n// so we init the PaymasterFactory in the main controller and use it\n// throught the app as a singleton\nexport class PaymasterFactory {\n  callRelayer: Function | undefined = undefined\n\n  errorCallback: Function | undefined = undefined\n\n  init(relayerUrl: string, fetch: Fetch, errorCallback: Function) {\n    this.callRelayer = relayerCall.bind({ url: relayerUrl, fetch })\n    this.errorCallback = errorCallback\n  }\n\n  async create(\n    op: AccountOp,\n    userOp: UserOperation,\n    network: Network,\n    provider: RPCProvider\n  ): Promise<AbstractPaymaster> {\n    if (this.callRelayer === undefined || this.errorCallback === undefined)\n      throw new Error('call init first')\n\n    // check whether the sponsorship has failed and if it has,\n    // mark it like so in the meta for the paymaster to know\n    const localOp = { ...op }\n    const paymasterServiceId = op.meta?.paymasterService?.id\n    if (paymasterServiceId && failedPaymasters.hasFailedSponsorship(paymasterServiceId)) {\n      if (localOp.meta && localOp.meta.paymasterService) localOp.meta.paymasterService.failed = true\n    }\n\n    const paymaster = new Paymaster(this.callRelayer, this.errorCallback)\n    await paymaster.init(localOp, userOp, network, provider)\n    return paymaster\n  }\n}\n"]}