{"version":3,"file":"aaveV3.js","sourceRoot":"","sources":["../../../../../src/libs/defiPositions/providers/aaveV3.ts"],"names":[],"mappings":"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","sourcesContent":["import { JsonRpcProvider, Provider } from 'ethers'\nimport { v4 as uuidv4 } from 'uuid'\n\nimport DeFiPositionsDeploylessCode from '../../../../contracts/compiled/DeFiAAVEPosition.json'\nimport { Network } from '../../../interfaces/network'\nimport { fromDescriptor } from '../../deployless/deployless'\nimport { AAVE_V3 } from '../defiAddresses'\nimport { getAssetValue } from '../helpers'\nimport { AssetType, Position, PositionAsset, PositionsByProvider } from '../types'\n\nconst AAVE_NO_HEALTH_FACTOR_MAGIC_NUMBER =\n  115792089237316195423570985008687907853269984665640564039457584007913129639935n\n\nexport async function getAAVEPositions(\n  userAddr: string,\n  provider: Provider | JsonRpcProvider,\n  network: Network\n): Promise<PositionsByProvider | null> {\n  const networkId = network.id\n  if (networkId && !AAVE_V3[networkId as keyof typeof AAVE_V3]) return null\n\n  const { poolAddr } = AAVE_V3[networkId as keyof typeof AAVE_V3]\n\n  const deploylessDeFiPositionsGetter = fromDescriptor(\n    provider,\n    DeFiPositionsDeploylessCode,\n    network.rpcNoStateOverride\n  )\n  const [[result0], [result1], [result2]] = await Promise.all([\n    deploylessDeFiPositionsGetter.call('getAAVEPosition', [userAddr, poolAddr, 0, 15], {}),\n    deploylessDeFiPositionsGetter.call('getAAVEPosition', [userAddr, poolAddr, 15, 30], {}),\n    deploylessDeFiPositionsGetter.call('getAAVEPosition', [userAddr, poolAddr, 30, 45], {})\n  ])\n\n  const accountDataRes = result0[1]\n\n  const userAssets = [...result0[0], ...result1[0], ...result2[0]]\n    .map((asset: any) => ({\n      address: asset[0],\n      symbol: asset[1],\n      balance: asset[2],\n      decimals: asset[3],\n      price: asset[4],\n      borrowAssetBalance: asset[5],\n      stableBorrowAssetBalance: asset[6],\n      currentLiquidityRate: asset[7],\n      currentVariableBorrowRate: asset[8],\n      currentStableBorrowRate: asset[9],\n\n      aaveAddress: asset[10],\n      aaveSymbol: asset[11],\n      aaveDecimals: asset[12],\n\n      aaveSDebtAddr: asset[13],\n      aaveSDebtSymbol: asset[14],\n      aaveSDebtDecimals: asset[15],\n\n      aaveVDebtAddr: asset[16],\n      aaveVDebtSymbol: asset[17],\n      aaveVDebtDecimals: asset[18]\n    }))\n    .filter((t: any) => t.balance > 0 || t.borrowAssetBalance > 0 || t.stableBorrowAssetBalance > 0)\n\n  const accountData = {\n    totalCollateralBase: accountDataRes[0],\n    totalDebtBase: accountDataRes[1],\n    availableBorrowsBase: accountDataRes[2],\n    currentLiquidationThreshold: accountDataRes[3],\n    ltv: accountDataRes[4],\n    healthFactor: accountDataRes[5]\n  }\n\n  if (accountData.healthFactor === AAVE_NO_HEALTH_FACTOR_MAGIC_NUMBER) {\n    accountData.healthFactor = null\n  }\n\n  const position = {\n    id: uuidv4(),\n    additionalData: {\n      healthRate: accountData.healthFactor ? Number(accountData.healthFactor) / 1e18 : null,\n      positionInUSD: 0,\n      deptInUSD: 0,\n      collateralInUSD: 0,\n      availableBorrowInUSD: Number(accountData.availableBorrowsBase) / 1e8\n    },\n    assets: []\n  } as Position\n\n  position.assets = userAssets\n    .map((asset: any) => {\n      const balance = Number(asset.balance) / 10 ** Number(asset.decimals)\n      const price = Number(asset.price) / 1e8\n      const borrow = (Number(asset.borrowAssetBalance) / 10 ** Number(asset.decimals)) * -1\n      const stableBorrow =\n        (Number(asset.stableBorrowAssetBalance) / 10 ** Number(asset.decimals)) * -1\n\n      position.additionalData.positionInUSD += (balance + borrow + stableBorrow) * price\n      position.additionalData.deptInUSD += borrow * price\n      position.additionalData.deptInUSD += stableBorrow * price\n      position.additionalData.collateralInUSD += balance * price\n\n      const assetsResult = []\n\n      const priceIn = [{ baseCurrency: 'usd', price }]\n\n      if (asset.balance > 0) {\n        assetsResult.push({\n          address: asset.address,\n          symbol: asset.symbol,\n          decimals: Number(asset.decimals),\n          amount: asset.balance,\n          priceIn,\n          value: getAssetValue(asset.balance, Number(asset.decimals), priceIn),\n          type: AssetType.Collateral,\n          additionalData: {\n            APY: Number(asset.currentLiquidityRate) / 10 ** 25\n          },\n          protocolAsset: {\n            address: asset.aaveAddress,\n            symbol: asset.aaveSymbol,\n            decimals: asset.aaveDecimals\n          }\n        } as PositionAsset)\n      }\n\n      if (asset.stableBorrowAssetBalanc > 0) {\n        assetsResult.push({\n          address: asset.address,\n          symbol: asset.symbol,\n          decimals: Number(asset.decimals),\n          amount: asset.stableBorrowAssetBalanc,\n          priceIn,\n          value: getAssetValue(asset.stableBorrowAssetBalanc, Number(asset.decimals), priceIn),\n          type: AssetType.Borrow,\n          additionalData: {\n            APY: Number(asset.currentStableBorrowRate) / 10 ** 25\n          },\n          protocolAsset: {\n            address: asset.aaveSDebtAddr,\n            symbol: asset.aaveSDebtSymbol,\n            decimals: asset.aaveSDebtDecimals\n          }\n        } as PositionAsset)\n      }\n\n      if (asset.borrowAssetBalance > 0) {\n        assetsResult.push({\n          address: asset.address,\n          symbol: asset.symbol,\n          decimals: Number(asset.decimals),\n          amount: asset.borrowAssetBalance,\n          priceIn,\n          value: getAssetValue(asset.borrowAssetBalance, Number(asset.decimals), priceIn),\n          type: AssetType.Borrow,\n          additionalData: {\n            APY: Number(asset.currentVariableBorrowRate) / 10 ** 25\n          },\n          protocolAsset: {\n            address: asset.aaveVDebtAddr,\n            symbol: asset.aaveVDebtSymbol,\n            decimals: asset.aaveVDebtDecimals\n          }\n        } as PositionAsset)\n      }\n\n      return assetsResult\n    })\n    .flat()\n\n  if (position.additionalData.positionInUSD === 0 || !position.assets.length) return null\n\n  return {\n    providerName: 'AAVE v3',\n    networkId,\n    type: 'lending',\n    positions: [position],\n    positionInUSD: position.additionalData.positionInUSD\n  }\n}\n"]}