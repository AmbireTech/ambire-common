{"version":3,"file":"uniUniversalRouter.js","sourceRoot":"","sources":["../../../../../../src/libs/humanizer/modules/Uniswap/uniUniversalRouter.ts"],"names":[],"mappings":"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","sourcesContent":["import { AbiCoder, Interface, ZeroAddress } from 'ethers'\n\nimport { AccountOp } from '../../../accountOp/accountOp'\nimport { UniswapUniversalRouter } from '../../const/abis'\nimport { HumanizerVisualization, IrCall } from '../../interfaces'\nimport {\n  getAction,\n  getAddressVisualization,\n  getDeadline,\n  getLabel,\n  getToken,\n  getUnknownVisualization,\n  getWrapping\n} from '../../utils'\nimport { COMMANDS, COMMANDS_DESCRIPTIONS } from './Commands'\nimport { HumanizerUniMatcher } from './interfaces'\nimport { getUniRecipientText, parsePath, uniReduce } from './utils'\n\nconst coder = new AbiCoder()\n\nconst extractParams = (inputsDetails: any, input: any) => {\n  const types = inputsDetails.map((i: any) => i.type)\n  const decodedInput = coder.decode(types, input)\n\n  const params: any = {}\n  inputsDetails.forEach((item: any, index: number) => {\n    params[item.name] = decodedInput[index]\n  })\n\n  return params\n}\n\n// this function splits uniswap commands from single hex string to multiple hex strings\n// '0x1234' => ['0x12', '0x34']\nfunction parseCommands(commands: string): string[] | null {\n  // all commands are 1 byte = 2 hex chars\n  if (commands.length % 2) return null\n  if (!/^0x[0-9A-Fa-f]+$/.test(commands)) return null\n  const res: string[] = []\n  // iterate over pairs of chars\n  for (let i = 2; i < commands.length; i += 2) {\n    res.push(`0x${commands.slice(i, i + 2)}`)\n  }\n  return res\n}\n\nexport const uniUniversalRouter = (): HumanizerUniMatcher => {\n  const ifaceUniversalRouter = new Interface(UniswapUniversalRouter)\n  return {\n    [`${\n      ifaceUniversalRouter.getFunction(\n        'execute(bytes calldata commands, bytes[] calldata inputs, uint256 deadline)'\n      )?.selector\n    }`]: (accountOp: AccountOp, call: IrCall) => {\n      const [commands, inputs, deadline] = ifaceUniversalRouter.parseTransaction(call)?.args || []\n      const parsedCommands = parseCommands(commands)\n      const parsed: HumanizerVisualization[][] = []\n\n      parsedCommands\n        ? parsedCommands.forEach((command: string, index: number) => {\n            if (command === COMMANDS.V3_SWAP_EXACT_IN) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.V3_SWAP_EXACT_IN\n              const params = extractParams(inputsDetails, inputs[index])\n              const path = parsePath(params.path)\n              parsed.push([\n                getAction('Swap'),\n                getToken(path[0], params.amountIn),\n                getLabel('for at least'),\n                getToken(path[path.length - 1], params.amountOutMin),\n                getDeadline(deadline)\n              ])\n            } else if (command === COMMANDS.V3_SWAP_EXACT_OUT) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.V3_SWAP_EXACT_OUT\n              const params = extractParams(inputsDetails, inputs[index])\n              const path = parsePath(params.path)\n\n              parsed.push([\n                getAction('Swap up to'),\n                getToken(path[path.length - 1], params.amountInMax),\n                getLabel('for'),\n                getToken(path[0], params.amountOut),\n                getDeadline(deadline)\n              ])\n            } else if (command === COMMANDS.SWEEP) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.SWEEP\n              const params = extractParams(inputsDetails, inputs[index])\n              if (\n                ['0x0000000000000000000000000000000000000001', accountOp.accountAddr].includes(\n                  params.recipient\n                )\n              )\n                parsed.push([\n                  getAction('Take'),\n                  getLabel('at least'),\n                  getToken(params.token, params.amountMin)\n                ])\n              else\n                parsed.push([\n                  getAction('Send'),\n                  getToken(params.token, params.amountMin),\n                  getLabel('to'),\n                  getAddressVisualization(params.recipient)\n                ])\n            } else if (command === COMMANDS.PAY_PORTION) {\n              // @NOTE: this is used for paying fee although its already calculated in the humanized response\n              // @NOTE: no need to be displayed but we can add warning id the fee is too high?\n              // const { inputsDetails } = COMMANDS_DESCRIPTIONS.PAY_PORTION\n              // const params = extractParams(inputsDetails, inputs[index])\n              // parsed.push({\n              //   ...call,\n              //   fullVisualization: [\n              //     getAction('Pay fee'),\n              //     getLabel('of'),\n              //     // bips are fee. can be 0 or within 10-9999 and converts to %\n              //     // https://docs.uniswap.org/contracts/v2/guides/interface-integration/custom-interface-linking#constraints\n              //     getLabel(`${Number(params.bips) / 100}%`)\n              //   ]\n              // })\n            } else if (command === COMMANDS.TRANSFER) {\n              // when we swap with exact out the ui displays amount X for out token\n              // the actual swap is X + small fee\n              // and this is the small fee that is to be sent to the fee collector of uniswap\n              // at later stage of the humanizer pipeline if swap with the same token is present exactly before this transfer\n              // we will subtract the amount from the swap and remove this call from the visualization\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.TRANSFER\n              const params = extractParams(inputsDetails, inputs[index])\n              parsed.push([\n                getAction('Send'),\n                getToken(params.token, params.value),\n                getLabel('to'),\n                getAddressVisualization(params.recipient)\n              ])\n            } else if (command === COMMANDS.V2_SWAP_EXACT_IN) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.V2_SWAP_EXACT_IN\n              const params = extractParams(inputsDetails, inputs[index])\n              const path = params.path\n\n              parsed.push([\n                getAction('Swap'),\n                getToken(path[0], params.amountIn),\n                getLabel('for at least'),\n                getToken(path[path.length - 1], params.amountOutMin),\n                getDeadline(deadline)\n              ])\n            } else if (command === COMMANDS.V2_SWAP_EXACT_OUT) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.V2_SWAP_EXACT_OUT\n              const params = extractParams(inputsDetails, inputs[index])\n              const path = params.path\n\n              parsed.push([\n                getAction('Swap up to'),\n                getToken(path[0], params.amountInMax),\n                getLabel('for'),\n                getToken(path[path.length - 1], params.amountOut),\n                getDeadline(deadline)\n              ])\n            } else if (command === COMMANDS.PERMIT2_PERMIT) {\n              const {\n                permit: {\n                  details: { token, amount /* expiration, nonce */ },\n                  spender\n                  // sigDeadline\n                }\n                // signature\n              } = extractParams(COMMANDS_DESCRIPTIONS.PERMIT2_PERMIT.inputsDetails, inputs[index])\n              parsed.push([\n                getAction('Grant approval'),\n                getLabel('for'),\n                getToken(token, amount),\n                getLabel('to'),\n                getAddressVisualization(spender)\n              ])\n            } else if (command === COMMANDS.WRAP_ETH) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.WRAP_ETH\n              const params = extractParams(inputsDetails, inputs[index])\n              params.amountMin && parsed.push(getWrapping(ZeroAddress, params.amountMin))\n            } else if (command === COMMANDS.UNWRAP_WETH) {\n              const { inputsDetails } = COMMANDS_DESCRIPTIONS.UNWRAP_WETH\n              const params = extractParams(inputsDetails, inputs[index])\n\n              params.amountMin &&\n                parsed.push([\n                  getAction('Unwrap'),\n                  getToken(ZeroAddress, params.amountMin),\n                  ...getUniRecipientText(accountOp.accountAddr, params.recipient)\n                ])\n            } else parsed.push(getUnknownVisualization('Uni V3', call))\n          })\n        : parsed.push(getUnknownVisualization('Uniswap V3', call))\n\n      return uniReduce(parsed)\n    }\n  }\n}\n"]}