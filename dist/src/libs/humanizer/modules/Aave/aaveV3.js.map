{"version":3,"file":"aaveV3.js","sourceRoot":"","sources":["../../../../../../src/libs/humanizer/modules/Aave/aaveV3.ts"],"names":[],"mappings":"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","sourcesContent":["import { Interface, MaxUint256 } from 'ethers'\n\nimport { NetworkId } from '../../../../interfaces/network'\nimport { AccountOp } from '../../../accountOp/accountOp'\nimport { AaveV3Pool } from '../../const/abis'\nimport { IrCall } from '../../interfaces'\nimport {\n  getAction,\n  getAddressVisualization,\n  getDeadline,\n  getLabel,\n  getOnBehalfOf,\n  getToken\n} from '../../utils'\n\n/*\nFetched via\n  let maxValueForUint16 = 65535\n  let tokenIdsStorageSlot = 54\n  let poolAddress = '0x794a61358D6845594F94dc1DB02A252b5b4814aD'\n  for (let i = 0; i < maxValueForUint16; i++) {\n    const storageSlot = solidityPackedKeccak256(['uint256', 'uint256'], [i, tokenIdsStorageSlot])\n    const res = await provider.getStorage(poolAddress, storageSlot)\n    if (res !== '0x0000000000000000000000000000000000000000000000000000000000000000')\n      console.log(res, i)\n\n  pool address is taken from\n  https://aave.com/docs/resources/addresses\n*/\nconst AAVE_TOKENS_BY_INDEX: { [network: NetworkId]: string[] } = {\n  optimism: [\n    '0xda10009cbd5d07dd0cecc66161fc93d7c9000da1',\n    '0x350a791bfc2c21f9ed5d10980dad2e2638ffa7f6',\n    '0x7f5c764cbc14f9669b88837ca1490cca17c31607',\n    '0x68f180fcce6836688e9084f035309e29bf0a2095',\n    '0x4200000000000000000000000000000000000006',\n    '0x94b008aa00579c1307b0ef2c499ad98a8ce58e58',\n    '0x76fb31fb4af56892a25e32cfc43de717950c9278',\n    '0x8c6f28f2f1a3c87f0f938b96d27520d9751ec8d9',\n    '0x4200000000000000000000000000000000000042',\n    '0x1f32b1c2345538c0c6f582fcb022739c4a194ebb',\n    '0xc40f949f8a4e094d1b49a23ea9241d289b7b2819',\n    '0xdfa46478f9e5ea86d57387849598dbfb2e964b02',\n    '0x9bcef72be871e61ed4fbbc7630889bee758eb81d',\n    '0x0b2c639c533813f4aa9d7837caf62653d097ff85'\n  ],\n  arbitrum: [\n    '0xda10009cbd5d07dd0cecc66161fc93d7c9000da1',\n    '0xf97f4df75117a78c1a5a0dbb814af92458539fb4',\n    '0xff970a61a04b1ca14834a43f5de4533ebddb5cc8',\n    '0x2f2a2543b76a4166549f7aab2e75bef0aefc5b0f',\n    '0x82af49447d8a07e3bd95bd0d56f35241523fbab1',\n    '0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9',\n    '0xba5ddd1f9d7f570dc94a51479a000e3bce967196',\n    '0xd22a58f79e9481d1a88e00c343885a588b34b68b',\n    '0x5979d7b546e38e414f7e9822514be443a4800529',\n    '0x3f56e0c36d275367b8c502090edf38289b3dea0d',\n    '0xec70dcb4a1efa46b8f2d97c310c9c4790ba5ffa8',\n    '0x93b346b6bc2548da6a1e7d98e9a421b42541425b',\n    '0xaf88d065e77c8cc2239327c5edb3a432268e5831',\n    '0x17fc002b466eec40dae837fc4be5c67993ddbd6f',\n    '0x912ce59144191c1204e64559fe8253a0e49e6548',\n    '0x35751007a407ca6feffe80b3cb397736d2cf4dbe',\n    '0x7dff72693f6a4149b17e7c6314655f6a9f7c8b33',\n    '0x2416092f143378750bb29b79ed961ab195cceea5'\n  ],\n  avalanche: [\n    '0xd586e7f844cea2f87f50152665bcbc2c279d8d70',\n    '0x5947bb275c521040051d82396192181b413227a3',\n    '0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e',\n    '0x50b7545627a5162f82a992c33b87adc75187b218',\n    '0x49d5c2bdffac6ce2bfdb6640f4f80f226bc10bab',\n    '0x9702230a8ea53601f5cd2dc00fdbc13d4df4a8c7',\n    '0x63a72806098bd3d9520cc43356dd78afe5d386d9',\n    '0xb31f66aa3c1e785363f0875a1b74e27b85fd66c7',\n    '0x2b2c81e08f1af8835a78bb2a90ae924ace0ea4be',\n    '0xd24c2ad096400b6fbcd2ad8b24e7acbc21a1da64',\n    '0x5c49b268c9841aff1cc3b0a418ff5c3442ee3f3b',\n    '0x152b9d0fdc40c096757f570a51e494bd4b943e50',\n    '0x00000000efe302beaa2b3e6e1b18d08d69a9012a'\n  ],\n  polygon: [\n    '0x8f3cf7ad23cd3cadbd9735aff958023239c6a063',\n    '0x53e0bca35ec356bd5dddfebbd1fc0fd03fabad39',\n    '0x2791bca1f2de4661ed88a30c99a7a9449aa84174',\n    '0x1bfd67037b42cf73acf2047067bd4f2c47d9bfd6',\n    '0x7ceb23fd6bc0add59e62ac25578270cff1b9f619',\n    '0xc2132d05d31c914a87c6611c10748aeb04b58e8f',\n    '0xd6df932a45c0f255f85145f286ea0b292b21c90b',\n    '0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270',\n    '0x172370d5cd63279efa6d502dab29171933a610af',\n    '0x0b3f868e0be5597d5db7feb59e1cadbb0fdda50a',\n    '0x385eeac5cb85a38a9a07a70c73e0a3271cfb54a7',\n    '0x9a71012b13ca4d3d0cdc72a177df3ef03b0e76a3',\n    '0x85955046df4668e1dd369d2de9f3aeb98dd2a369',\n    '0xe111178a87a3bff0c8d18decba5798827539ae99',\n    '0x4e3decbb3645551b8a19f0ea1678079fcb33fb4c',\n    '0xe0b52e49357fd4daf2c15e02058dce6bc0057db4',\n    '0xa3fa99a148fa48d14ed51d610c367c61876997f1',\n    '0x3a58a54c066fdc0f2d55fc9c89f0415c92ebf3c4',\n    '0xfa68fb4628dff1028cfec22b4162fccd0d45efb6',\n    '0x03b54a6e9a984069379fae1a4fc4dbae93b3bccd',\n    '0x3c499c542cef5e3811e1192ce70d8cc03d5c3359'\n  ],\n  base: [\n    '0x4200000000000000000000000000000000000006',\n    '0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22',\n    '0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca',\n    '0xc1cba3fcea344f92d9239c08c0568f6f2f0ee452',\n    '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913',\n    '0x04c0599ae5a44757c0af6f9ec3b93da8976c150a',\n    '0xcbb7c0000ab88b473b1f5afd9ef808440eed33bf',\n    '0x2416092f143378750bb29b79ed961ab195cceea5'\n  ]\n}\nexport const aaveV3Pool = (): { [key: string]: Function } => {\n  const iface = new Interface(AaveV3Pool)\n  return {\n    [iface.getFunction(\n      'supply(address asset, uint256 amount, address onBehalfOf, uint16 referralCode)'\n    )?.selector!]: (accountOp: AccountOp, call: IrCall) => {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { asset, amount, onBehalfOf, referralCode } = iface.parseTransaction(call)!.args\n      return [\n        getAction('Deposit'),\n        getToken(asset, amount),\n        getLabel('to'),\n        getAddressVisualization(call.to),\n        ...getOnBehalfOf(onBehalfOf, accountOp.accountAddr)\n      ]\n    },\n    [iface.getFunction(\n      'flashLoanSimple(address receiverAddress, address asset, uint256 amount, bytes params, uint16 referralCode)'\n    )?.selector!]: (accountOp: AccountOp, call: IrCall) => {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { receiverAddress, asset, amount, params, referralCode } =\n        iface.parseTransaction(call)!.args\n\n      return [\n        getAction('Execute Flash Loan'),\n        getToken(asset, amount),\n        getLabel('and call'),\n        getAddressVisualization(receiverAddress)\n      ]\n    },\n    [iface.getFunction('repayWithATokens(bytes32 args)')?.selector!]: (\n      accountOp: AccountOp,\n      call: IrCall\n    ) => {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { args } = iface.parseTransaction(call)!.args\n      return [getAction('Repay with token A'), getLabel('to'), getAddressVisualization(call.to)]\n    },\n    [iface.getFunction('repayWithPermit(bytes32 args, bytes32 r, bytes32 s)')?.selector!]: (\n      accountOp: AccountOp,\n      call: IrCall\n    ) => {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { args } = iface.parseTransaction(call)!.args\n      return [getAction('Repay with permit'), getLabel('to'), getAddressVisualization(call.to)]\n    },\n    [iface.getFunction(\n      'supplyWithPermit(address asset, uint256 amount, address onBehalfOf, uint16 referralCode, uint256 deadline, uint8 permitV, bytes32 permitR, bytes32 permitS)'\n    )?.selector!]: (accountOp: AccountOp, call: IrCall) => {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { asset, amount, onBehalfOf, referralCode, deadline, permitV, permitR, bytes32 } =\n        iface.parseTransaction(call)!.args\n      return [\n        getAction('Supply'),\n        getToken(asset, amount),\n        getLabel('to'),\n        getAddressVisualization(call.to),\n        ...(onBehalfOf !== accountOp.accountAddr\n          ? [getLabel('on behalf of'), getAddressVisualization(onBehalfOf)]\n          : []),\n        getDeadline(deadline)\n      ]\n    },\n    [iface.getFunction('withdraw(bytes32 args)')?.selector!]: (\n      accountOp: AccountOp,\n      call: IrCall\n    ) => {\n      // @TODO  do some hecks for network OR\n      const { args } = iface.parseTransaction(call)!.args\n      const amountAsString = args.slice(30, 62)\n      const tokenIndex = Number(`0x${args.slice(62)}`)\n      if (!AAVE_TOKENS_BY_INDEX[accountOp.networkId])\n        return [getAction('Withdraw'), getLabel('from'), getAddressVisualization(call.to)]\n\n      if (tokenIndex >= AAVE_TOKENS_BY_INDEX[accountOp.networkId].length)\n        return [getAction('Withdraw'), getLabel('from'), getAddressVisualization(call.to)]\n\n      // stores amount inn uint128 instead of uint256, but max value is treated as max value\n      const amount = amountAsString === 'f'.repeat(32) ? MaxUint256 : BigInt(`0x${amountAsString}`)\n\n      return [\n        getAction('Withdraw'),\n        getToken(AAVE_TOKENS_BY_INDEX[accountOp.networkId][tokenIndex], amount),\n        getLabel('from'),\n        getAddressVisualization(call.to)\n      ]\n    }\n  }\n}\n"]}