{"version":3,"file":"selectedAccount.js","sourceRoot":"","sources":["../../../../src/libs/selectedAccount/selectedAccount.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  SelectedAccountPortfolio,\n  SelectedAccountPortfolioState,\n  SelectedAccountPortfolioTokenResult\n} from '../../interfaces/selectedAccount'\nimport { safeTokenAmountAndNumberMultiplication } from '../../utils/numbers/formatters'\nimport {\n  AccountState as DefiPositionsAccountState,\n  AssetType,\n  PositionsByProvider\n} from '../defiPositions/types'\nimport {\n  AccountState,\n  CollectionResult,\n  NetworkSimulatedAccountOp,\n  NetworkState,\n  TokenResult\n} from '../portfolio/interfaces'\n\nexport const updatePortfolioStateWithDefiPositions = (\n  portfolioAccountState: AccountState,\n  defiPositionsAccountState: DefiPositionsAccountState,\n  areDefiPositionsLoading: boolean\n) => {\n  if (!portfolioAccountState || !defiPositionsAccountState || areDefiPositionsLoading)\n    return portfolioAccountState\n\n  Object.keys(portfolioAccountState).forEach((chainId) => {\n    const networkState = portfolioAccountState[chainId]\n\n    if (!networkState?.result || defiPositionsAccountState[chainId]?.isLoading) return\n\n    const tokens = networkState.result.tokens || []\n    let networkBalance = networkState.result.total?.usd || 0\n\n    const positions = defiPositionsAccountState[chainId] || {}\n\n    positions.positionsByProvider?.forEach((posByProv: PositionsByProvider) => {\n      if (posByProv.type === 'liquidity-pool') {\n        networkBalance += posByProv.positionInUSD || 0\n        return\n      }\n\n      posByProv.positions.forEach((pos) => {\n        pos.assets\n          .filter((a) => a.type !== AssetType.Liquidity && a.protocolAsset)\n          .forEach((a) => {\n            const tokenInPortfolio = tokens.find((t) => {\n              return (\n                t.address.toLowerCase() === (a.protocolAsset?.address || '').toLowerCase() &&\n                t.chainId.toString() === chainId &&\n                !t.flags.rewardsType &&\n                !t.flags.onGasTank\n              )\n            })\n\n            if (tokenInPortfolio?.flags.isHidden) return\n\n            // Add only the balance of the collateral tokens to the network balance\n            if (a.type === AssetType.Collateral) {\n              const protocolPriceUSD = a.priceIn.find(\n                ({ baseCurrency }: { baseCurrency: string }) => baseCurrency.toLowerCase() === 'usd'\n              )?.price\n\n              const protocolTokenBalanceUSD = protocolPriceUSD\n                ? Number(\n                    safeTokenAmountAndNumberMultiplication(\n                      BigInt(tokenInPortfolio?.amountPostSimulation || a.amount),\n                      Number(a.protocolAsset!.decimals),\n                      protocolPriceUSD\n                    )\n                  )\n                : undefined\n\n              networkBalance += protocolTokenBalanceUSD || 0\n            }\n\n            if (tokenInPortfolio) {\n              const priceUSD = tokenInPortfolio.priceIn.find(\n                ({ baseCurrency }: { baseCurrency: string }) => baseCurrency.toLowerCase() === 'usd'\n              )?.price\n\n              const tokenBalanceUSD = priceUSD\n                ? Number(\n                    safeTokenAmountAndNumberMultiplication(\n                      BigInt(tokenInPortfolio.amountPostSimulation || tokenInPortfolio.amount),\n                      tokenInPortfolio.decimals,\n                      priceUSD\n                    )\n                  )\n                : undefined\n\n              networkBalance -= tokenBalanceUSD || 0 // deduct portfolio token balance\n              // Get the price from defiPositions\n              tokenInPortfolio.priceIn = a.type === AssetType.Collateral ? a.priceIn : []\n              tokenInPortfolio.flags.defiTokenType = a.type\n            } else {\n              const positionAsset: TokenResult = {\n                amount: a.amount,\n                // Only list the borrowed asset with no price\n                priceIn: a.type === AssetType.Collateral ? a.priceIn : [],\n                decimals: Number(a.protocolAsset!.decimals),\n                address: a.protocolAsset!.address,\n                symbol: a.protocolAsset!.symbol,\n                name: a.protocolAsset!.name,\n                chainId: BigInt(chainId),\n                flags: {\n                  canTopUpGasTank: false,\n                  isFeeToken: false,\n                  onGasTank: false,\n                  rewardsType: null,\n                  defiTokenType: a.type\n                  // @BUG: defi positions tokens can't be hidden and can be added as custom\n                  // because processTokens is called in the portfolio\n                  // Issue: https://github.com/AmbireTech/ambire-app/issues/3971\n                }\n              }\n\n              tokens.push(positionAsset)\n            }\n          })\n      })\n    })\n\n    // eslint-disable-next-line no-param-reassign\n    portfolioAccountState[chainId]!.result!.total.usd = networkBalance\n    // eslint-disable-next-line no-param-reassign\n    portfolioAccountState[chainId]!.result!.tokens = tokens\n  })\n\n  return portfolioAccountState\n}\n\nconst stripPortfolioState = (portfolioState: AccountState) => {\n  const strippedState: SelectedAccountPortfolioState = {}\n\n  Object.keys(portfolioState).forEach((chainId) => {\n    const networkState = portfolioState[chainId]\n    if (!networkState) return\n\n    if (!networkState.result) {\n      strippedState[chainId] = networkState\n      return\n    }\n\n    // A trick to exclude specific keys\n    const { tokens, collections, tokenErrors, priceCache, hintsFromExternalAPI, ...result } =\n      networkState.result\n\n    strippedState[chainId] = { ...networkState, result }\n  })\n\n  return strippedState\n}\n\nexport const isNetworkReady = (networkData: NetworkState | undefined) => {\n  return networkData && (networkData.isReady || networkData?.criticalError)\n}\n\nconst calculateTokenArray = (\n  chainId: string,\n  latestTokens: TokenResult[],\n  pendingTokens: TokenResult[],\n  isPendingValid: boolean\n) => {\n  if (chainId === 'gasTank' || chainId === 'rewards') {\n    return latestTokens\n  }\n  // If the pending state is older or there are no pending tokens\n  // we shouldn't trust it to build the tokens array\n  if (isPendingValid && pendingTokens.length) {\n    return pendingTokens.map((pendingToken) => {\n      const latestToken = latestTokens.find((latest) => {\n        return latest.address === pendingToken.address\n      })\n\n      return {\n        ...pendingToken,\n        latestAmount: latestToken?.amount,\n        pendingAmount: pendingToken.amount\n      }\n    })\n  }\n\n  // Add only latestAmount to the tokens\n  return latestTokens.map((token) => {\n    return {\n      ...token,\n      latestAmount: token.amount\n    }\n  })\n}\n\nexport function calculateSelectedAccountPortfolio(\n  latestStateSelectedAccount: AccountState,\n  pendingStateSelectedAccount: AccountState,\n  accountPortfolio: SelectedAccountPortfolio | null,\n  portfolioStartedLoadingAtTimestamp: number | null,\n  defiPositionsAccountState: DefiPositionsAccountState,\n  hasSignAccountOp: boolean,\n  isLoadingFromScratch: boolean\n): SelectedAccountPortfolio {\n  const now = Date.now()\n  const shouldShowPartialResult =\n    portfolioStartedLoadingAtTimestamp && now - portfolioStartedLoadingAtTimestamp > 5000\n  const collections: CollectionResult[] = []\n  const tokens: SelectedAccountPortfolioTokenResult[] = []\n\n  let newTotalBalance: number = 0\n\n  const hasLatest = latestStateSelectedAccount && Object.keys(latestStateSelectedAccount).length\n  let isAllReady = !!hasLatest\n  let isReadyToVisualize = false\n\n  const hasPending = pendingStateSelectedAccount && Object.keys(pendingStateSelectedAccount).length\n  if (!hasLatest && !hasPending) {\n    return {\n      tokens: accountPortfolio?.tokens || [],\n      collections: accountPortfolio?.collections || [],\n      totalBalance: accountPortfolio?.totalBalance || 0,\n      isReadyToVisualize: false,\n      isAllReady: false,\n      networkSimulatedAccountOp: accountPortfolio?.networkSimulatedAccountOp || {},\n      latest: latestStateSelectedAccount,\n      pending: pendingStateSelectedAccount\n    }\n  }\n\n  let selectedAccountData = latestStateSelectedAccount\n\n  /**\n   * Replaces the latest state if the following conditions are true:\n   * - There is no critical error in the pending state.\n   * - The pending block number is newer than the latest OR we have a signed acc op (because of simulation).\n   */\n  const validSelectedAccountPendingState: AccountState = {}\n  const simulatedAccountOps: NetworkSimulatedAccountOp = {}\n\n  Object.keys(pendingStateSelectedAccount).forEach((network) => {\n    const pendingNetworkData = pendingStateSelectedAccount[network]\n    const latestNetworkData = latestStateSelectedAccount[network]\n\n    // Compare the block numbers to determine if the pending state is newer\n    if (latestNetworkData?.result?.blockNumber && pendingNetworkData?.result?.blockNumber) {\n      const isPendingNewer =\n        pendingNetworkData.result.blockNumber! >= latestNetworkData.result.blockNumber!\n\n      if (!pendingNetworkData.criticalError && (isPendingNewer || hasSignAccountOp)) {\n        validSelectedAccountPendingState[network] = pendingNetworkData\n      }\n    }\n\n    // Store the simulated account op\n    const accountOp = pendingNetworkData?.accountOps?.[0]\n\n    if (accountOp) {\n      simulatedAccountOps[network] = accountOp\n    }\n  })\n\n  if (hasPending && Object.keys(validSelectedAccountPendingState).length > 0) {\n    selectedAccountData = {\n      ...selectedAccountData,\n      ...validSelectedAccountPendingState\n    }\n  }\n\n  Object.keys(selectedAccountData).forEach((network: string) => {\n    const networkData = selectedAccountData[network]\n    const result = networkData?.result\n\n    if (networkData && result) {\n      const networkTotal = Number(result?.total?.usd) || 0\n      newTotalBalance += networkTotal\n\n      const latestTokens = latestStateSelectedAccount[network]?.result?.tokens || []\n      const pendingTokens = pendingStateSelectedAccount[network]?.result?.tokens || []\n      const networkCollections = result?.collections || []\n\n      const tokensArray = calculateTokenArray(\n        network,\n        latestTokens,\n        pendingTokens,\n        !!validSelectedAccountPendingState[network]\n      )\n\n      tokens.push(...tokensArray)\n      collections.push(...networkCollections)\n    }\n\n    if (\n      // The network is not ready\n      !isNetworkReady(networkData) ||\n      // The networks is ready but the previous state isn't satisfactory and the network is still loading\n      (isLoadingFromScratch && networkData?.isLoading) ||\n      // The total balance and token list are affected by the defi positions\n      defiPositionsAccountState[network]?.isLoading\n    ) {\n      isAllReady = false\n    }\n  })\n\n  const tokensWithAmount = tokens.filter((token) => token.amount)\n\n  if ((shouldShowPartialResult && tokensWithAmount.length && !isAllReady) || isAllReady) {\n    // Allow the user to operate with the tokens that have loaded\n    isReadyToVisualize = true\n  }\n\n  return {\n    totalBalance: newTotalBalance,\n    tokens,\n    collections,\n    isReadyToVisualize,\n    isAllReady,\n    networkSimulatedAccountOp: simulatedAccountOps,\n    latest: stripPortfolioState(latestStateSelectedAccount),\n    pending: stripPortfolioState(pendingStateSelectedAccount)\n  } as SelectedAccountPortfolio\n}\n"]}