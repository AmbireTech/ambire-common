{"version":3,"file":"estimateWithRetries.js","sourceRoot":"","sources":["../../../../src/libs/estimate/estimateWithRetries.ts"],"names":[],"mappings":"AAAA,MAAM,CAAC,KAAK,UAAU,mBAAmB,CACvC,aAAuB,EACvB,WAAmB,EACnB,aAAuB,EACvB,gBAAwB,KAAK,EAC7B,UAAkB,CAAC;IAEnB,iCAAiC;IACjC,kEAAkE;IAClE,IAAI,OAAO,IAAI,CAAC;QACd,OAAO,IAAI,KAAK,CACd,wIAAwI,CACzI,CAAA;IAEH,MAAM,kBAAkB,GAAG,EAAE,CAAA;IAC7B,MAAM,iBAAiB,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;QAChD,UAAU,CAAC,GAAG,EAAE;YACd,OAAO,CAAC,kBAAkB,CAAC,CAAA;QAC7B,CAAC,EAAE,aAAa,CAAC,CAAA;IACnB,CAAC,CAAC,CAAA;IAEF,IAAI,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,aAAa,EAAE,CAAC,EAAE,iBAAiB,CAAC,CAAC,CAAA;IAElF,qBAAqB;IACrB,IAAI,MAAM,KAAK,kBAAkB,EAAE;QACjC,MAAM,WAAW,GAAG,OAAO,GAAG,CAAC,CAAA;QAE/B,gDAAgD;QAEhD,QAAQ,WAAW,EAAE;YACnB,KAAK,uBAAuB;gBAC1B,aAAa,CAAC;oBACZ,KAAK,EAAE,OAAO;oBACd,OAAO,EAAE,2DAA2D;oBACpE,KAAK,EAAE,IAAI,KAAK,CAAC,mCAAmC,CAAC;iBACtD,CAAC,CAAA;gBACF,MAAK;YAEP,KAAK,oBAAoB;gBACvB,aAAa,CAAC;oBACZ,KAAK,EAAE,OAAO;oBACd,OAAO,EAAE,+DAA+D;oBACxE,KAAK,EAAE,IAAI,KAAK,CAAC,qCAAqC,CAAC;iBACxD,CAAC,CAAA;gBACF,MAAK;YACP,KAAK,gBAAgB;gBACnB,aAAa,CAAC;oBACZ,KAAK,EAAE,OAAO;oBACd,OAAO,EAAE,6EAA6E;oBACtF,KAAK,EAAE,IAAI,KAAK,CAAC,qCAAqC,CAAC;iBACxD,CAAC,CAAA;gBACF,MAAK;YAEP;gBACE,MAAK;SACR;QAED,MAAM,GAAG,MAAM,mBAAmB,CAChC,aAAa,EACb,WAAW,EACX,aAAa,EACb,aAAa,EACb,WAAW,CACZ,CAAA;KACF;SAAM;QACL,kDAAkD;QAClD,MAAM,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,YAAY,KAAK,CAAC,CAAC,CAAC,CAAC,IAAI,CAAA;QACvF,IAAI,KAAK;YAAE,OAAO,KAAK,CAAA;KACxB;IAED,kBAAkB;IAClB,OAAO,MAAM,CAAA;AACf,CAAC","sourcesContent":["export async function estimateWithRetries(\n  fetchRequests: Function,\n  timeoutType: string,\n  errorCallback: Function,\n  timeoutInMill: number = 10000,\n  counter: number = 0\n): Promise<any> {\n  // stop the execution on 5 fails;\n  // the below error message is not shown to the user so we are safe\n  if (counter >= 5)\n    return new Error(\n      'Estimation failure, retrying in a couple of seconds. If this issue persists, please change your RPC provider or contact Ambire support'\n    )\n\n  const santinelTimeoutErr = {}\n  const estimationTimeout = new Promise((resolve) => {\n    setTimeout(() => {\n      resolve(santinelTimeoutErr)\n    }, timeoutInMill)\n  })\n\n  let result = await Promise.race([Promise.all(fetchRequests()), estimationTimeout])\n\n  // retry on a timeout\n  if (result === santinelTimeoutErr) {\n    const incremented = counter + 1\n\n    // display a timeout error only on the first try\n\n    switch (timeoutType) {\n      case 'estimation-deployless':\n        errorCallback({\n          level: 'major',\n          message: 'Estimating gas limits from the RPC timed out. Retrying...',\n          error: new Error('Estimation.sol deployless timeout')\n        })\n        break\n\n      case 'estimation-bundler':\n        errorCallback({\n          level: 'major',\n          message: 'Estimating gas limits from the bundler timed out. Retrying...',\n          error: new Error('Budler gas limit estimation timeout')\n        })\n        break\n      case 'estimation-eoa':\n        errorCallback({\n          level: 'major',\n          message: 'Estimating gas limits for Basic Account from the RPC timed out. Retrying...',\n          error: new Error('Budler gas limit estimation timeout')\n        })\n        break\n\n      default:\n        break\n    }\n\n    result = await estimateWithRetries(\n      fetchRequests,\n      timeoutType,\n      errorCallback,\n      timeoutInMill,\n      incremented\n    )\n  } else {\n    // if one of the calls returns an error, return it\n    const error = Array.isArray(result) ? result.find((res) => res instanceof Error) : null\n    if (error) return error\n  }\n\n  // success outcome\n  return result\n}\n"]}