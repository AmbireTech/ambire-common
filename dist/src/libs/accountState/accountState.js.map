{"version":3,"file":"accountState.js","sourceRoot":"","sources":["../../../../src/libs/accountState/accountState.ts"],"names":[],"mappings":";;AAgBA,0CAyHC;;AAzID,mCAAyC;AAEzC,0HAAoF;AACpF,gDAM4B;AAG5B,wCAAwD;AACxD,gDAA2E;AAC3E,yDAAyD;AAElD,KAAK,UAAU,eAAe,CACnC,QAAkB,EAClB,OAAgB,EAChB,QAAmB,EACnB,WAA4B,QAAQ;IAEpC,MAAM,sBAAsB,GAAG,IAAA,2BAAc,EAC3C,QAAQ,EACR,iCAAkB,EAClB,CAAC,OAAO,CAAC,kBAAkB,CAC5B,CAAA;IAED,MAAM,IAAI,GAAG,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE;QACpC,MAAM,cAAc,GAClB,OAAO,CAAC,OAAO,CAAC,OAAO,IAAI,CAAC,OAAO,CAAC,cAAc,CAAC,QAAQ,CAAC,4BAAmB,CAAC;YAC9E,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,cAAc,EAAE,4BAAmB,CAAC;YAClD,CAAC,CAAC,OAAO,CAAC,cAAc,CAAA;QAE5B,OAAO;YACL,OAAO,CAAC,IAAI;YACZ,cAAc;YACd,GAAG,CAAC,OAAO,CAAC,QAAQ,IAAI,IAAI;gBAC1B,CAAC,CAAC,CAAC,4CAA4C,EAAE,IAAI,CAAC;gBACtD,CAAC,CAAC,IAAA,gCAAsB,EAAC,OAAO,CAAC,CAAC;YACpC,4BAAmB;SACpB,CAAA;IACH,CAAC,CAAC,CAAA;IAEF,KAAK,UAAU,YAAY,CAAC,WAAkB;QAC5C,MAAM,MAAM,GAAQ,MAAM,OAAO,CAAC,GAAG,CACnC,WAAW,CAAC,GAAG,CAAC,CAAC,IAAY,EAAE,EAAE,CAAC,QAAQ,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC,CACtE,CAAA;QACD,OAAO,MAAM,CAAC,MAAM,CAClB,EAAE,EACF,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC,IAAY,EAAE,KAAsB,EAAE,EAAE,CAAC,CAAC;YAC5D,CAAC,IAAI,CAAC,EAAE,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;SAC9B,CAAC,CAAC,CACJ,CAAA;IACH,CAAC;IAED,KAAK,UAAU,WAAW,CAAC,WAAkB;QAC3C,MAAM,KAAK,GAAQ,MAAM,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,IAAY,EAAE,EAAE,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAA;QAC/F,OAAO,MAAM,CAAC,MAAM,CAClB,EAAE,EACF,GAAG,WAAW,CAAC,GAAG,CAAC,CAAC,IAAY,EAAE,KAAsB,EAAE,EAAE,CAAC,CAAC;YAC5D,CAAC,IAAI,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC;SACrB,CAAC,CAAC,CACJ,CAAA;IACH,CAAC;IAED,MAAM,IAAI,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,IAAA,wBAAc,EAAC,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;IAClG,MAAM,CAAC,CAAC,kBAAkB,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;QACpE,sBAAsB,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC,IAAI,CAAC,EAAE;YACtD,QAAQ;SACT,CAAC;QACF,YAAY,CAAC,IAAI,CAAC;QAClB,WAAW,CAAC,IAAI,CAAC;KAClB,CAAC,CAAA;IAEF,MAAM,MAAM,GAA0B,kBAAkB,CAAC,GAAG,CAAC,CAAC,SAAc,EAAE,KAAa,EAAE,EAAE;QAC7F,MAAM,cAAc,GAAG,SAAS,CAAC,uBAAuB,CAAC,GAAG,CAC1D,CAAC,SAAiB,EAAE,QAAgB,EAAE,EAAE;YACtC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,QAAQ,CAAC,EAAE,SAAS,CAAC,CAAA;QAC9C,CAAC,CACF,CAAA;QAED,MAAM,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAA;QAE/B,kCAAkC;QAClC,gCAAgC;QAChC,oCAAoC;QACpC,MAAM,iBAAiB,GACrB,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,UAAU,CAAC;YACrE,CAAC,CAAC,KAAK,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE;YAC5C,CAAC,CAAC,IAAI,CAAA;QACV,MAAM,mBAAmB,GACvB,QAAQ,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,IAAA,eAAM,EAAC,CAAC,UAAU,EAAE,IAAA,iCAAyB,EAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAA;QAC7F,MAAM,YAAY,GAAG,SAAS,CAAC,KAAK,IAAI,mBAAmB,CAAA;QAE3D,IAAI,qBAAqB,GAAG,IAAI,CAAA;QAEhC,IAAI,iBAAiB,EAAE,CAAC;YACtB,IAAI,iBAAiB,CAAC,WAAW,EAAE,KAAK,gCAAuB,CAAC,WAAW,EAAE,EAAE,CAAC;gBAC9E,qBAAqB,GAAG,QAAQ,CAAA;YAClC,CAAC;iBAAM,IAAI,iBAAiB,CAAC,WAAW,EAAE,KAAK,0BAAiB,CAAC,WAAW,EAAE,EAAE,CAAC;gBAC/E,qBAAqB,GAAG,UAAU,CAAA;YACpC,CAAC;iBAAM,CAAC;gBACN,qBAAqB,GAAG,SAAS,CAAA;YACnC,CAAC;QACH,CAAC;QAED,OAAO;YACL,WAAW,EAAE,OAAO,CAAC,IAAI;YACzB,QAAQ,EAAE,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI;YAC1D,KAAK,EAAE,CAAC,IAAA,wBAAc,EAAC,OAAO,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK;YAC5F,YAAY,EAAE,SAAS,CAAC,YAAY;YACpC,UAAU,EAAE,SAAS,CAAC,UAAU;YAChC,cAAc,EAAE,MAAM,CAAC,WAAW,CAAC,cAAc,CAAC;YAClD,IAAI,EAAE,SAAS,CAAC,IAAI;YACpB,OAAO,EAAE,SAAS,CAAC,OAAO;YAC1B,KAAK,EAAE,SAAS,CAAC,KAAK;YACtB,gBAAgB,EAAE,YAAY;gBAC5B,CAAC,CAAC,IAAI;gBACN,CAAC,CAAC,CAAC,CAAC,CACA,OAAO,CAAC,OAAO,CAAC,OAAO;oBACvB,SAAS,CAAC,YAAY,GAAG,oBAAW;oBACpC,cAAc,CAAC,IAAI,CACjB,CAAC,aAAuB,EAAE,EAAE,CAC1B,aAAa,CAAC,CAAC,CAAC,KAAK,4BAAmB,IAAI,aAAa,CAAC,CAAC,CAAC,KAAK,2BAAkB,CACtF,CACF;YACL,YAAY,EAAE,SAAS,CAAC,YAAY;YACpC,WAAW,EACT,OAAO,CAAC,cAAc,CAAC,MAAM,GAAG,CAAC,IAAI,SAAS,CAAC,uBAAuB,CAAC,MAAM,KAAK,CAAC;YACrF,YAAY;YACZ,iBAAiB;YACjB,qBAAqB;SACtB,CAAA;IACH,CAAC,CAAC,CAAA;IAEF,OAAO,MAAM,CAAA;AACf,CAAC","sourcesContent":["import { concat, Provider } from 'ethers'\n\nimport AmbireAccountState from '../../../contracts/compiled/AmbireAccountState.json'\nimport {\n  EIP_7702_AMBIRE_ACCOUNT,\n  EIP_7702_METAMASK,\n  ENTRY_POINT_MARKER,\n  ERC_4337_ENTRYPOINT,\n  MAX_UINT256\n} from '../../consts/deploy'\nimport { Account, AccountOnchainState } from '../../interfaces/account'\nimport { Network } from '../../interfaces/network'\nimport { getContractImplementation } from '../7702/7702'\nimport { getAccountDeployParams, isSmartAccount } from '../account/account'\nimport { fromDescriptor } from '../deployless/deployless'\n\nexport async function getAccountState(\n  provider: Provider,\n  network: Network,\n  accounts: Account[],\n  blockTag: string | number = 'latest'\n): Promise<AccountOnchainState[]> {\n  const deploylessAccountState = fromDescriptor(\n    provider,\n    AmbireAccountState,\n    !network.rpcNoStateOverride\n  )\n\n  const args = accounts.map((account) => {\n    const associatedKeys =\n      network.erc4337.enabled && !account.associatedKeys.includes(ERC_4337_ENTRYPOINT)\n        ? [...account.associatedKeys, ERC_4337_ENTRYPOINT]\n        : account.associatedKeys\n\n    return [\n      account.addr,\n      associatedKeys,\n      ...(account.creation == null\n        ? ['0x0000000000000000000000000000000000000000', '0x']\n        : getAccountDeployParams(account)),\n      ERC_4337_ENTRYPOINT\n    ]\n  })\n\n  async function getEOAsNonce(eoaAccounts: any[]): Promise<{ [addr: string]: number }> {\n    const nonces: any = await Promise.all(\n      eoaAccounts.map((addr: string) => provider.getTransactionCount(addr))\n    )\n    return Object.assign(\n      {},\n      ...eoaAccounts.map((addr: string, index: string | number) => ({\n        [addr]: BigInt(nonces[index])\n      }))\n    )\n  }\n\n  async function getEOAsCode(eoaAccounts: any[]): Promise<{ [addr: string]: string }> {\n    const codes: any = await Promise.all(eoaAccounts.map((addr: string) => provider.getCode(addr)))\n    return Object.assign(\n      {},\n      ...eoaAccounts.map((addr: string, index: string | number) => ({\n        [addr]: codes[index]\n      }))\n    )\n  }\n\n  const eoas = accounts.filter((account) => !isSmartAccount(account)).map((account) => account.addr)\n  const [[accountStateResult], eoaNonces, eoaCodes] = await Promise.all([\n    deploylessAccountState.call('getAccountsState', [args], {\n      blockTag\n    }),\n    getEOAsNonce(eoas),\n    getEOAsCode(eoas)\n  ])\n\n  const result: AccountOnchainState[] = accountStateResult.map((accResult: any, index: number) => {\n    const associatedKeys = accResult.associatedKeyPrivileges.map(\n      (privilege: string, keyIndex: number) => {\n        return [args[index][1][keyIndex], privilege]\n      }\n    )\n\n    const account = accounts[index]\n\n    // an EOA is smarter if it either:\n    // - has an active authorization\n    // - has an active AMBIRE delegation\n    const delegatedContract =\n      eoaCodes[account.addr] && eoaCodes[account.addr].startsWith('0xef0100')\n        ? `0x${eoaCodes[account.addr].substring(8)}`\n        : null\n    const hasAmbireDelegation =\n      eoaCodes[account.addr] === concat(['0xef0100', getContractImplementation(network.chainId)])\n    const isSmarterEoa = accResult.isEOA && hasAmbireDelegation\n\n    let delegatedContractName = null\n\n    if (delegatedContract) {\n      if (delegatedContract.toLowerCase() === EIP_7702_AMBIRE_ACCOUNT.toLowerCase()) {\n        delegatedContractName = 'AMBIRE'\n      } else if (delegatedContract.toLowerCase() === EIP_7702_METAMASK.toLowerCase()) {\n        delegatedContractName = 'METAMASK'\n      } else {\n        delegatedContractName = 'UNKNOWN'\n      }\n    }\n\n    return {\n      accountAddr: account.addr,\n      eoaNonce: accResult.isEOA ? eoaNonces[account.addr] : null,\n      nonce: !isSmartAccount(account) && !isSmarterEoa ? eoaNonces[account.addr] : accResult.nonce,\n      erc4337Nonce: accResult.erc4337Nonce,\n      isDeployed: accResult.isDeployed,\n      associatedKeys: Object.fromEntries(associatedKeys),\n      isV2: accResult.isV2,\n      balance: accResult.balance,\n      isEOA: accResult.isEOA,\n      isErc4337Enabled: isSmarterEoa\n        ? true\n        : !!(\n            network.erc4337.enabled &&\n            accResult.erc4337Nonce < MAX_UINT256 &&\n            associatedKeys.find(\n              (associatedKey: string[]) =>\n                associatedKey[0] === ERC_4337_ENTRYPOINT && associatedKey[1] === ENTRY_POINT_MARKER\n            )\n          ),\n      currentBlock: accResult.currentBlock,\n      deployError:\n        account.associatedKeys.length > 0 && accResult.associatedKeyPrivileges.length === 0,\n      isSmarterEoa,\n      delegatedContract,\n      delegatedContractName\n    }\n  })\n\n  return result\n}\n"]}