{"version":3,"file":"helper.js","sourceRoot":"","sources":["../../../../src/controllers/signAccountOp/helper.ts"],"names":[],"mappings":"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","sourcesContent":["import { formatUnits, ZeroAddress } from 'ethers'\n\nimport { WARNINGS } from '../../consts/signAccountOp/errorHandling'\nimport { Network } from '../../interfaces/network'\nimport { Warning, TraceCallDiscoveryStatus } from '../../interfaces/signAccountOp'\nimport { SubmittedAccountOp } from '../../libs/accountOp/submittedAccountOp'\nimport { FeePaymentOption } from '../../libs/estimate/interfaces'\nimport { Price, TokenResult } from '../../libs/portfolio'\nimport { getAccountPortfolioTotal, getTotal } from '../../libs/portfolio/helpers'\nimport { AccountState } from '../../libs/portfolio/interfaces'\n\nfunction getFeeSpeedIdentifier(\n  option: FeePaymentOption,\n  accountAddr: string,\n  rbfAccountOp: SubmittedAccountOp | null\n) {\n  // if the token is native and we're paying with EOA, we do not need\n  // a different identifier as the fee speed calculations will be the same\n  // regardless of the EOA address\n  const paidBy =\n    option.token.address === ZeroAddress && option.paidBy !== accountAddr ? 'EOA' : option.paidBy\n\n  return `${paidBy}:${option.token.address}:${option.token.symbol.toLowerCase()}:${\n    option.token.flags.onGasTank ? 'gasTank' : 'feeToken'\n  }${rbfAccountOp ? `rbf-${option.paidBy}` : ''}`\n}\n\nfunction getTokenUsdAmount(token: TokenResult, gasAmount: bigint): string {\n  const isUsd = (price: Price) => price.baseCurrency === 'usd'\n  const usdPrice = token.priceIn.find(isUsd)?.price\n\n  if (!usdPrice) return ''\n\n  const usdPriceFormatted = BigInt(usdPrice * 1e18)\n\n  // 18 it's because we multiply usdPrice * 1e18 and here we need to deduct it\n  return formatUnits(BigInt(gasAmount) * usdPriceFormatted, 18 + token.decimals)\n}\n\nfunction getSignificantBalanceDecreaseWarning(\n  latest: AccountState,\n  pending: AccountState,\n  networkId: Network['id'],\n  traceCallDiscoveryStatus: TraceCallDiscoveryStatus\n): Warning | null {\n  const latestNetworkData = latest?.[networkId]\n  const pendingNetworkData = pending?.[networkId]\n  const canDetermineIfBalanceWillDecrease =\n    latestNetworkData &&\n    !latestNetworkData.isLoading &&\n    pendingNetworkData &&\n    !pendingNetworkData.isLoading\n\n  if (canDetermineIfBalanceWillDecrease) {\n    const latestTotal = getAccountPortfolioTotal(latest, ['rewards', 'gasTank'], false)\n    const latestOnNetwork = getTotal(latestNetworkData.result?.tokens || []).usd\n    const pendingOnNetwork = getTotal(pendingNetworkData.result?.tokens || []).usd\n    const willBalanceDecreaseByMoreThan10Percent =\n      latestOnNetwork - pendingOnNetwork > latestTotal * 0.1\n\n    if (!willBalanceDecreaseByMoreThan10Percent) return null\n\n    // We wait for the discovery process (main.traceCall) to complete before showing WARNINGS.significantBalanceDecrease.\n    // This is important because, in the case of a SWAP to a new token, the new token is not yet part of the portfolio,\n    // which could incorrectly trigger a significant balance drop warning.\n    // To prevent this, we ensure the discovery process is completed first.\n    if (traceCallDiscoveryStatus === TraceCallDiscoveryStatus.Done) {\n      return WARNINGS.significantBalanceDecrease\n    }\n\n    // If the discovery process takes too long (more than 2 seconds) or fails,\n    // we still show a warning, but we indicate that our balance decrease assumption may be incorrect.\n    if (\n      traceCallDiscoveryStatus === TraceCallDiscoveryStatus.Failed ||\n      traceCallDiscoveryStatus === TraceCallDiscoveryStatus.SlowPendingResponse\n    ) {\n      return WARNINGS.possibleBalanceDecrease\n    }\n  }\n\n  return null\n}\n\nconst getFeeTokenPriceUnavailableWarning = (\n  hasSpeed: boolean,\n  feeTokenHasPrice: boolean\n): Warning | null => {\n  if (!hasSpeed || feeTokenHasPrice) return null\n\n  return WARNINGS.feeTokenPriceUnavailable\n}\n\nexport {\n  getFeeSpeedIdentifier,\n  getTokenUsdAmount,\n  getSignificantBalanceDecreaseWarning,\n  getFeeTokenPriceUnavailableWarning\n}\n"]}