{"version":3,"file":"dapps.js","sourceRoot":"","sources":["../../../../src/controllers/dapps/dapps.ts"],"names":[],"mappings":"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","sourcesContent":["import { Session, SessionProp } from '../../classes/session'\nimport predefinedDapps from '../../consts/dappCatalog.json'\nimport { Dapp } from '../../interfaces/dapp'\nimport { Messenger } from '../../interfaces/messenger'\nimport { patchStorageApps } from '../../libs/dapps/helpers'\nimport EventEmitter from '../eventEmitter/eventEmitter'\nimport { StorageController } from '../storage/storage'\n\n// The DappsController is responsible for the following tasks:\n// 1. Managing the dApp catalog\n// 2. Handling active sessions between dApps and the wallet\n// 3. Broadcasting events from the wallet to connected dApps via the Session\n\n// The possible events include: accountsChanged, chainChanged, disconnect, lock, unlock, and connect.\n\nexport class DappsController extends EventEmitter {\n  #dapps: Dapp[] = []\n\n  #storage: StorageController\n\n  dappSessions: { [key: string]: Session } = {}\n\n  // Holds the initial load promise, so that one can wait until it completes\n  initialLoadPromise: Promise<void>\n\n  constructor(storage: StorageController) {\n    super()\n\n    this.#storage = storage\n\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.initialLoadPromise = this.#load()\n  }\n\n  get isReady() {\n    return !!this.dapps\n  }\n\n  get dapps(): Dapp[] {\n    const predefinedDappsParsed = predefinedDapps.map(\n      ({ url, name, icon, description }): Dapp => ({\n        name,\n        description,\n        url,\n        icon,\n        isConnected: false,\n        chainId: 1,\n        favorite: false\n      })\n    )\n\n    return [...this.#dapps, ...predefinedDappsParsed].reduce((acc: Dapp[], curr: Dapp): Dapp[] => {\n      if (!acc.some(({ url }) => url === curr.url)) return [...acc, curr]\n      return acc\n    }, [])\n  }\n\n  set dapps(updatedDapps: Dapp[]) {\n    this.#dapps = updatedDapps\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.#storage.set('dapps', updatedDapps)\n  }\n\n  async #load() {\n    // Before extension version 4.55.0, dappSessions were stored in storage.\n    // This logic is no longer needed, so we remove the data from the user's storage.\n    // Keeping this here as a reminder to handle future use of the `dappSessions` key with caution.\n    this.#storage.remove('dappSessions')\n    const storedDapps = await this.#storage.get('dapps', [])\n\n    this.#dapps = patchStorageApps(storedDapps)\n    this.emitUpdate()\n  }\n\n  #dappSessionsSet(sessionId: string, session: Session) {\n    this.dappSessions[sessionId] = session\n  }\n\n  #dappSessionsDelete(sessionId: string) {\n    delete this.dappSessions[sessionId]\n  }\n\n  #createDappSession = (data: SessionProp) => {\n    const dappSession = new Session(data)\n    this.#dappSessionsSet(dappSession.sessionId, dappSession)\n    this.emitUpdate()\n\n    return dappSession\n  }\n\n  getOrCreateDappSession = (data: SessionProp) => {\n    if (!data.tabId || !data.origin)\n      throw new Error('Invalid props passed to getOrCreateDappSession')\n\n    if (this.dappSessions[`${data.tabId}-${data.origin}`]) {\n      return this.dappSessions[`${data.tabId}-${data.origin}`]\n    }\n\n    return this.#createDappSession(data)\n  }\n\n  setSessionMessenger = (key: string, messenger: Messenger) => {\n    this.dappSessions[key].setMessenger(messenger)\n  }\n\n  setSessionLastHandledRequestsId = (key: string, id: number, isWeb3AppRequest?: boolean) => {\n    if (id > this.dappSessions[key].lastHandledRequestId) {\n      this.dappSessions[key].lastHandledRequestId = id\n      if (isWeb3AppRequest && !this.dappSessions[key].isWeb3App) {\n        this.dappSessions[key].isWeb3App = true\n        this.emitUpdate()\n      }\n    }\n  }\n\n  resetSessionLastHandledRequestsId = (key: string) => {\n    this.dappSessions[key].lastHandledRequestId = -1\n  }\n\n  setSessionProp = (key: string, props: SessionProp) => {\n    this.dappSessions[key].setProp(props)\n  }\n\n  deleteDappSession = (key: string) => {\n    this.#dappSessionsDelete(key)\n    this.emitUpdate()\n  }\n\n  broadcastDappSessionEvent = async (\n    ev: any,\n    data?: any,\n    origin?: string,\n    skipPermissionCheck?: boolean\n  ) => {\n    await this.initialLoadPromise\n\n    let dappSessions: { key: string; data: Session }[] = []\n    Object.keys(this.dappSessions).forEach((key) => {\n      const hasPermissionToBroadcast =\n        skipPermissionCheck || this.hasPermission(this.dappSessions[key].origin)\n      if (this.dappSessions[key] && hasPermissionToBroadcast) {\n        dappSessions.push({ key, data: this.dappSessions[key] })\n      }\n    })\n    if (origin) {\n      dappSessions = dappSessions.filter((dappSession) => dappSession.data.origin === origin)\n    }\n\n    dappSessions.forEach((dappSession) => {\n      try {\n        dappSession.data.sendMessage?.(ev, data)\n      } catch (e) {\n        if (this.dappSessions[dappSession.key]) {\n          this.deleteDappSession(dappSession.key)\n        }\n      }\n    })\n  }\n\n  addDapp(dapp: Dapp) {\n    if (!this.isReady) return\n\n    const doesAlreadyExist = this.dapps.find((d) => d.url === dapp.url)\n    if (doesAlreadyExist) {\n      this.updateDapp(dapp.url, {\n        chainId: dapp.chainId,\n        isConnected: dapp.isConnected,\n        favorite: dapp.favorite\n      })\n      return\n    }\n    this.dapps = [...this.dapps, dapp]\n    this.emitUpdate()\n  }\n\n  updateDapp(url: string, dapp: Partial<Dapp>) {\n    if (!this.isReady) return\n\n    this.dapps = this.dapps.map((d) => {\n      if (d.url === url) return { ...d, ...dapp }\n      return d\n    })\n    this.emitUpdate()\n  }\n\n  removeDapp(url: string) {\n    if (!this.isReady) return\n\n    // do not remove predefined dapps\n    if (predefinedDapps.find((d) => d.url === url)) return\n\n    this.dapps = this.dapps.filter((d) => d.url !== url)\n    this.emitUpdate()\n  }\n\n  hasPermission(url: string) {\n    const dapp = this.dapps.find((d) => d.url === url)\n    if (!dapp) return false\n\n    return dapp.isConnected\n  }\n\n  getDapp(url: string) {\n    if (!this.isReady) return\n\n    return this.dapps.find((d) => d.url === url)\n  }\n\n  toJSON() {\n    return {\n      ...this,\n      ...super.toJSON(),\n      dapps: this.dapps,\n      isReady: this.isReady\n    }\n  }\n}\n"]}