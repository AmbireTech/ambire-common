{"version":3,"file":"providers.js","sourceRoot":"","sources":["../../../../src/controllers/providers/providers.ts"],"names":[],"mappings":";;;;AAGA,sDAAwD;AACxD,wFAAuD;AAGvD;;;GAGG;AACH,MAAa,mBAAoB,SAAQ,sBAAY;IACnD,SAAS,CAAoB;IAE7B,SAAS,GAAiB,EAAE,CAAA;IAE5B,0EAA0E;IAC1E,kBAAkB,CAAe;IAEjC,YAAY,QAA4B;QACtC,KAAK,EAAE,CAAA;QAEP,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAA;QACzB,mEAAmE;QACnE,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,KAAK,EAAE,CAAA;IACxC,CAAC;IAED,IAAI,aAAa;QACf,OAAO,IAAI,CAAC,SAAS,CAAC,aAAa,IAAI,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC,MAAM,CAAA;IAC7E,CAAC;IAED,KAAK,CAAC,KAAK;QACT,MAAM,IAAI,CAAC,SAAS,CAAC,kBAAkB,CAAA;QACvC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,CAAA;QAC3D,IAAI,CAAC,UAAU,EAAE,CAAA;IACnB,CAAC;IAED,WAAW,CAAC,OAAgB;QAC1B,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAA;QAE3D,mHAAmH;QACnH,IAAI,CAAC,QAAQ,IAAI,QAAQ,EAAE,cAAc,EAAE,CAAC,GAAG,KAAK,OAAO,CAAC,cAAc,EAAE,CAAC;YAC3E,MAAM,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAA;YAEzD,wIAAwI;YACxI,IAAI,CAAC;gBACH,IAAI,MAAM;oBAAE,MAAM,CAAC,OAAO,EAAE,CAAA;YAC9B,CAAC;YAAC,OAAO,CAAC,EAAE,CAAC;gBACX,kFAAkF;YACpF,CAAC;YAED,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,GAAG,IAAA,yBAAc,EACzD,OAAO,CAAC,OAAO,EACf,OAAO,CAAC,OAAO,EACf,OAAO,CAAC,cAAc,CACvB,CAAA;QACH,CAAC;IACH,CAAC;IAED,uBAAuB,CAAC,OAAe,EAAE,SAAkB;QACzD,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YAAE,OAAM;QAC/C,IAAI,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC,SAAS,KAAK,SAAS;YAAE,OAAM;QAEtE,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC,SAAS,GAAG,SAAS,CAAA;QACxD,IAAI,CAAC,UAAU,EAAE,CAAA;IACnB,CAAC;IAED,cAAc,CAAC,OAAe;QAC5B,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC;YAAE,OAAM;QAE/C,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,EAAE,OAAO,EAAE,CAAA;QAC7C,OAAO,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAA;QACzC,IAAI,CAAC,UAAU,EAAE,CAAA;IACnB,CAAC;IAED,MAAM;QACJ,OAAO;YACL,GAAG,IAAI;YACP,GAAG,KAAK,CAAC,MAAM,EAAE;YACjB,aAAa,EAAE,IAAI,CAAC,aAAa;SAClC,CAAA;IACH,CAAC;CACF;AAvED,kDAuEC","sourcesContent":["/* eslint-disable no-underscore-dangle */\nimport { Network } from '../../interfaces/network'\nimport { RPCProviders } from '../../interfaces/provider'\nimport { getRpcProvider } from '../../services/provider'\nimport EventEmitter from '../eventEmitter/eventEmitter'\nimport { NetworksController } from '../networks/networks'\n\n/**\n * The ProvidersController manages RPC providers, enabling the extension to communicate with the blockchain.\n * Each network requires an initialized JsonRpcProvider, and the provider must be reinitialized whenever network.selectedRpcUrl changes.\n */\nexport class ProvidersController extends EventEmitter {\n  #networks: NetworksController\n\n  providers: RPCProviders = {}\n\n  // Holds the initial load promise, so that one can wait until it completes\n  initialLoadPromise: Promise<void>\n\n  constructor(networks: NetworksController) {\n    super()\n\n    this.#networks = networks\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this.initialLoadPromise = this.#load()\n  }\n\n  get isInitialized() {\n    return this.#networks.isInitialized && !!Object.keys(this.providers).length\n  }\n\n  async #load() {\n    await this.#networks.initialLoadPromise\n    this.#networks.networks.forEach((n) => this.setProvider(n))\n    this.emitUpdate()\n  }\n\n  setProvider(network: Network) {\n    const provider = this.providers[network.chainId.toString()]\n\n    // Only update the RPC if the new RPC is different from the current one or if there is no RPC for this network yet.\n    if (!provider || provider?._getConnection().url !== network.selectedRpcUrl) {\n      const oldRPC = this.providers[network.chainId.toString()]\n\n      // If an RPC fails once it will try to reconnect every second. If we don't destroy the old RPC it will keep trying to reconnect forever.\n      try {\n        if (oldRPC) oldRPC.destroy()\n      } catch (e) {\n        // no need to do anything; try/catch is just in case a double destroy is attempted\n      }\n\n      this.providers[network.chainId.toString()] = getRpcProvider(\n        network.rpcUrls,\n        network.chainId,\n        network.selectedRpcUrl\n      )\n    }\n  }\n\n  updateProviderIsWorking(chainId: bigint, isWorking: boolean) {\n    if (!this.providers[chainId.toString()]) return\n    if (this.providers[chainId.toString()].isWorking === isWorking) return\n\n    this.providers[chainId.toString()].isWorking = isWorking\n    this.emitUpdate()\n  }\n\n  removeProvider(chainId: bigint) {\n    if (!this.providers[chainId.toString()]) return\n\n    this.providers[chainId.toString()]?.destroy()\n    delete this.providers[chainId.toString()]\n    this.emitUpdate()\n  }\n\n  toJSON() {\n    return {\n      ...this,\n      ...super.toJSON(),\n      isInitialized: this.isInitialized\n    }\n  }\n}\n"]}