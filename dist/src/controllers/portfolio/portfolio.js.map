{"version":3,"file":"portfolio.js","sourceRoot":"","sources":["../../../../src/controllers/portfolio/portfolio.ts"],"names":[],"mappings":"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","sourcesContent":["import { getAddress, ZeroAddress } from 'ethers'\n\nimport { STK_WALLET } from '../../consts/addresses'\nimport { Account, AccountId, AccountOnchainState } from '../../interfaces/account'\nimport { Fetch } from '../../interfaces/fetch'\nimport { Network } from '../../interfaces/network'\nimport { canBecomeSmarter, isBasicAccount, isSmartAccount } from '../../libs/account/account'\n/* eslint-disable @typescript-eslint/no-shadow */\nimport { AccountOp, isAccountOpsIntentEqual } from '../../libs/accountOp/accountOp'\nimport { AccountOpStatus } from '../../libs/accountOp/types'\nimport { Portfolio } from '../../libs/portfolio'\nimport batcher from '../../libs/portfolio/batcher'\n/* eslint-disable @typescript-eslint/no-use-before-define */\nimport { CustomToken, TokenPreference } from '../../libs/portfolio/customToken'\nimport getAccountNetworksWithAssets from '../../libs/portfolio/getNetworksWithAssets'\nimport {\n  getFlags,\n  getTokensReadyToLearn,\n  getTotal,\n  getUpdatedHints,\n  processTokens,\n  validateERC20Token\n} from '../../libs/portfolio/helpers'\n/* eslint-disable no-restricted-syntax */\n// eslint-disable-next-line import/no-cycle\nimport {\n  AccountAssetsState,\n  AccountState,\n  GasTankTokenResult,\n  GetOptions,\n  NetworkState,\n  PortfolioControllerState,\n  PreviousHintsStorage,\n  TemporaryTokens,\n  TokenResult\n} from '../../libs/portfolio/interfaces'\nimport { relayerCall } from '../../libs/relayerCall/relayerCall'\nimport { AccountsController } from '../accounts/accounts'\nimport EventEmitter from '../eventEmitter/eventEmitter'\nimport { KeystoreController } from '../keystore/keystore'\nimport { NetworksController } from '../networks/networks'\nimport { ProvidersController } from '../providers/providers'\nimport { StorageController } from '../storage/storage'\n\n/* eslint-disable @typescript-eslint/no-shadow */\n\nconst LEARNED_TOKENS_NETWORK_LIMIT = 50\n\nexport class PortfolioController extends EventEmitter {\n  #latest: PortfolioControllerState\n\n  #pending: PortfolioControllerState\n\n  // A queue to prevent race conditions when calling `updateSelectedAccount`.\n  // All calls are queued by network and account.\n  // Each time `updateSelectedAccount` is invoked to update the latest or pending state, the call is added to the queue.\n  // If a previous call is still running, the new call will be queued and executed only after the first one completes,\n  // regardless of whether it succeeds or fails.\n  // Before implementing this queue, multiple `updateSelectedAccount` calls made in a short period of time could cause\n  // the response of the latest call to be overwritten by a slower previous call.\n  #queue: { [accountId: string]: { [chainId: string]: Promise<void> } }\n\n  #toBeLearnedTokens: { [chainId: string]: string[] }\n\n  customTokens: CustomToken[] = []\n\n  tokenPreferences: TokenPreference[] = []\n\n  validTokens: any = { erc20: {}, erc721: {} }\n\n  temporaryTokens: TemporaryTokens = {}\n\n  #portfolioLibs: Map<string, Portfolio>\n\n  #storage: StorageController\n\n  #fetch: Fetch\n\n  #callRelayer: Function\n\n  #velcroUrl: string\n\n  #batchedVelcroDiscovery: Function\n\n  #networksWithAssetsByAccounts: {\n    [accountId: string]: AccountAssetsState\n  } = {}\n\n  #minUpdateInterval: number = 20000 // 20 seconds\n\n  /**\n   * Hints stored in storage, divided into three categories:\n   * - fromExternalAPI: Hints fetched from an external API, used when the external API response fails.\n   * - learnedTokens: Hints of learned tokens, each with a timestamp indicating the last time the token was seen with a balance and not included in fromExternalAPI hints. This helps prioritize tokens not yet found by Velcro during cleansing.\n   * - learnedNfts: Hints of learned NFTs.\n   */\n  #previousHints: PreviousHintsStorage = {\n    fromExternalAPI: {},\n    learnedTokens: {},\n    learnedNfts: {}\n  }\n\n  #providers: ProvidersController\n\n  #networks: NetworksController\n\n  #accounts: AccountsController\n\n  #keystore: KeystoreController\n\n  // Holds the initial load promise, so that one can wait until it completes\n  #initialLoadPromise: Promise<void>\n\n  constructor(\n    storage: StorageController,\n    fetch: Fetch,\n    providers: ProvidersController,\n    networks: NetworksController,\n    accounts: AccountsController,\n    keystore: KeystoreController,\n    relayerUrl: string,\n    velcroUrl: string\n  ) {\n    super()\n    this.#latest = {}\n    this.#pending = {}\n    this.#queue = {}\n    this.#portfolioLibs = new Map()\n    this.#storage = storage\n    this.#fetch = fetch\n    this.#callRelayer = relayerCall.bind({ url: relayerUrl, fetch })\n    this.#velcroUrl = velcroUrl\n    this.#providers = providers\n    this.#networks = networks\n    this.#accounts = accounts\n    this.#keystore = keystore\n    this.temporaryTokens = {}\n    this.#toBeLearnedTokens = {}\n    this.#batchedVelcroDiscovery = batcher(\n      fetch,\n      (queue) => {\n        const baseCurrencies = [...new Set(queue.map((x) => x.data.baseCurrency))]\n        return baseCurrencies.map((baseCurrency) => {\n          const queueSegment = queue.filter((x) => x.data.baseCurrency === baseCurrency)\n\n          const url = `${velcroUrl}/multi-hints?networks=${queueSegment\n            .map((x) => x.data.chainId)\n            .join(',')}&accounts=${queueSegment\n            .map((x) => x.data.accountAddr)\n            .join(',')}&baseCurrency=${baseCurrency}`\n\n          return { url, queueSegment }\n        })\n      },\n      {\n        timeoutSettings: {\n          timeoutAfter: 3000,\n          timeoutErrorMessage: 'Velcro discovery timed out'\n        },\n        dedupeByKeys: ['chainId', 'accountAddr']\n      }\n    )\n\n    this.#initialLoadPromise = this.#load()\n  }\n\n  async #load() {\n    try {\n      await this.#networks.initialLoadPromise\n      await this.#accounts.initialLoadPromise\n\n      this.tokenPreferences = await this.#storage.get('tokenPreferences', [])\n      this.customTokens = await this.#storage.get('customTokens', [])\n\n      this.#previousHints = await this.#storage.get('previousHints', {})\n      const networksWithAssets = await this.#storage.get('networksWithAssetsByAccount', {})\n      const isOldStructure = Object.keys(networksWithAssets).every(\n        (key) =>\n          Array.isArray(networksWithAssets[key]) &&\n          (networksWithAssets[key] as any).every((item: any) => typeof item === 'string')\n      )\n      if (!isOldStructure) {\n        this.#networksWithAssetsByAccounts = networksWithAssets\n      }\n    } catch (e) {\n      this.emitError({\n        message:\n          'Something went wrong when loading portfolio. Please try again or contact support if the problem persists.',\n        level: 'major',\n        error: new Error('portfolio: failed to pull keys from storage')\n      })\n    }\n\n    this.emitUpdate()\n  }\n\n  async #updatePortfolioOnTokenChange(chainId: bigint, selectedAccountAddr?: string) {\n    // As this function currently only updates the portfolio we can skip it altogether\n    // if skipPortfolioUpdate is set to true\n    if (!selectedAccountAddr) return\n\n    const networkData = this.#networks.networks.find((n) => n.chainId === chainId)\n    await this.updateSelectedAccount(selectedAccountAddr, networkData, undefined, {\n      forceUpdate: true\n    })\n  }\n\n  async addCustomToken(\n    customToken: CustomToken,\n    selectedAccountAddr?: string,\n    shouldUpdatePortfolio?: boolean\n  ) {\n    await this.#initialLoadPromise\n    const isTokenAlreadyAdded = this.customTokens.some(\n      ({ address, chainId }) =>\n        address.toLowerCase() === customToken.address.toLowerCase() &&\n        chainId === customToken.chainId\n    )\n\n    if (isTokenAlreadyAdded) return\n\n    this.customTokens.push(customToken)\n\n    if (shouldUpdatePortfolio) {\n      await this.#updatePortfolioOnTokenChange(customToken.chainId, selectedAccountAddr)\n    }\n\n    await this.#storage.set('customTokens', this.customTokens)\n  }\n\n  async removeCustomToken(\n    customToken: Omit<CustomToken, 'standard'>,\n    selectedAccountAddr?: string,\n    shouldUpdatePortfolio?: boolean\n  ) {\n    await this.#initialLoadPromise\n    this.customTokens = this.customTokens.filter(\n      (token) =>\n        !(\n          token.address.toLowerCase() === customToken.address.toLowerCase() &&\n          token.chainId === customToken.chainId\n        )\n    )\n    const existingPreference = this.tokenPreferences.some(\n      (pref) => pref.address === customToken.address && pref.chainId === customToken.chainId\n    )\n\n    // Delete custom token preference if it exists\n    if (existingPreference) {\n      await this.toggleHideToken(customToken, selectedAccountAddr, shouldUpdatePortfolio)\n      await this.#storage.set('customTokens', this.customTokens)\n    } else {\n      this.emitUpdate()\n      if (shouldUpdatePortfolio) {\n        await this.#updatePortfolioOnTokenChange(customToken.chainId, selectedAccountAddr)\n      }\n      await this.#storage.set('customTokens', this.customTokens)\n    }\n  }\n\n  async toggleHideToken(\n    tokenPreference: TokenPreference,\n    selectedAccountAddr?: string,\n    shouldUpdatePortfolio?: boolean\n  ) {\n    await this.#initialLoadPromise\n\n    const existingPreference = this.tokenPreferences.find(\n      ({ address, chainId }) =>\n        address.toLowerCase() === tokenPreference.address.toLowerCase() &&\n        chainId === tokenPreference.chainId\n    )\n\n    // Push the token as hidden\n    if (!existingPreference) {\n      this.tokenPreferences.push({ ...tokenPreference, isHidden: true })\n      // Remove the token preference if the user decides to show it again\n    } else if (existingPreference.isHidden) {\n      this.tokenPreferences = this.tokenPreferences.filter(\n        ({ address, chainId }) =>\n          !(address === tokenPreference.address && chainId === tokenPreference.chainId)\n      )\n    } else {\n      // Should happen only after migration\n      existingPreference.isHidden = !existingPreference.isHidden\n    }\n\n    this.emitUpdate()\n    if (shouldUpdatePortfolio) {\n      await this.#updatePortfolioOnTokenChange(tokenPreference.chainId, selectedAccountAddr)\n    }\n    await this.#storage.set('tokenPreferences', this.tokenPreferences)\n  }\n\n  async #updateNetworksWithAssets(accountId: AccountId, accountState: AccountState) {\n    const storageStateByAccount = this.#networksWithAssetsByAccounts\n\n    this.#networksWithAssetsByAccounts[accountId] = getAccountNetworksWithAssets(\n      accountId,\n      accountState,\n      storageStateByAccount,\n      this.#providers.providers\n    )\n\n    this.emitUpdate()\n    await this.#storage.set('networksWithAssetsByAccount', this.#networksWithAssetsByAccounts)\n  }\n\n  #setNetworkLoading(\n    accountId: AccountId,\n    stateKey: 'latest' | 'pending',\n    network: string,\n    isLoading: boolean,\n    error?: any\n  ) {\n    const states = {\n      latest: this.#latest,\n      pending: this.#pending\n    }\n    const accountState = states[stateKey][accountId]\n    if (!accountState[network]) accountState[network] = { errors: [], isReady: false, isLoading }\n    accountState[network]!.isLoading = isLoading\n    if (error)\n      accountState[network]!.criticalError = {\n        message:\n          error?.message || 'Error while executing the get function in the portfolio library.',\n        simulationErrorMsg: error?.simulationErrorMsg,\n        stack: error?.stack,\n        name: error?.name\n      }\n  }\n\n  removeNetworkData(chainId: bigint) {\n    for (const accountState of [this.#latest, this.#pending]) {\n      for (const accountId of Object.keys(accountState)) {\n        delete accountState[accountId][chainId.toString()]\n      }\n    }\n    this.emitUpdate()\n  }\n\n  // make the pending results the same as the latest ones\n  overridePendingResults(accountOp: AccountOp) {\n    if (\n      this.#pending[accountOp.accountAddr] &&\n      this.#pending[accountOp.accountAddr][accountOp.chainId.toString()] &&\n      this.#latest[accountOp.accountAddr] &&\n      this.#latest[accountOp.accountAddr][accountOp.chainId.toString()]\n    ) {\n      this.#pending[accountOp.accountAddr][accountOp.chainId.toString()]!.result =\n        this.#latest[accountOp.accountAddr][accountOp.chainId.toString()]!.result\n      this.emitUpdate()\n    }\n  }\n\n  async updateTokenValidationByStandard(\n    token: { address: TokenResult['address']; chainId: TokenResult['chainId'] },\n    accountId: AccountId\n  ) {\n    await this.#initialLoadPromise\n    if (this.validTokens.erc20[`${token.address}-${token.chainId}`] === true) return\n\n    const [isValid, standard]: [boolean, string] = (await validateERC20Token(\n      token,\n      accountId,\n      this.#providers.providers[token.chainId.toString()]\n    )) as [boolean, string]\n\n    this.validTokens[standard] = {\n      ...this.validTokens[standard],\n      [`${token.address}-${token.chainId}`]: isValid\n    }\n\n    this.emitUpdate()\n  }\n\n  initializePortfolioLibIfNeeded(accountId: AccountId, chainId: bigint, network: Network) {\n    const providers = this.#providers.providers\n    const key = `${chainId}:${accountId}`\n    // Initialize a new Portfolio lib if:\n    // 1. It does not exist in the portfolioLibs map\n    // 2. The network RPC URL has changed\n    if (\n      !this.#portfolioLibs.has(key) ||\n      this.#portfolioLibs.get(key)?.network?.selectedRpcUrl !==\n        // eslint-disable-next-line no-underscore-dangle\n        providers[network.chainId.toString()]?._getConnection().url\n    ) {\n      this.#portfolioLibs.set(\n        key,\n        new Portfolio(\n          this.#fetch,\n          providers[network.chainId.toString()],\n          network,\n          this.#velcroUrl,\n          this.#batchedVelcroDiscovery\n        )\n      )\n    }\n    return this.#portfolioLibs.get(key)!\n  }\n\n  async getTemporaryTokens(accountId: AccountId, chainId: bigint, additionalHint: string) {\n    const network = this.#networks.networks.find((x) => x.chainId === chainId)\n\n    if (!network) throw new Error('network not found')\n\n    const portfolioLib = this.initializePortfolioLibIfNeeded(accountId, chainId, network)\n\n    const temporaryTokensToFetch =\n      (this.temporaryTokens[network.chainId.toString()] &&\n        this.temporaryTokens[network.chainId.toString()].result?.tokens.filter(\n          (x) => x.address !== additionalHint\n        )) ||\n      []\n\n    this.temporaryTokens[network.chainId.toString()] = {\n      isLoading: false,\n      errors: [],\n      result:\n        this.temporaryTokens[network.chainId.toString()] &&\n        this.temporaryTokens[network.chainId.toString()].result\n    }\n    this.emitUpdate()\n\n    try {\n      const result = await portfolioLib.get(accountId, {\n        priceRecency: 60000,\n        additionalErc20Hints: [additionalHint, ...temporaryTokensToFetch.map((x) => x.address)],\n        disableAutoDiscovery: true\n      })\n      this.temporaryTokens[network.chainId.toString()] = {\n        isLoading: false,\n        errors: [],\n        result: {\n          tokens: result.tokens\n        }\n      }\n      this.emitUpdate()\n      return true\n    } catch (e: any) {\n      this.emitError({\n        level: 'silent',\n        message: \"Error while executing the 'get' function in the portfolio library.\",\n        error: e\n      })\n      this.temporaryTokens[network.chainId.toString()].isLoading = false\n      this.temporaryTokens[network.chainId.toString()].errors.push(e)\n      this.emitUpdate()\n      return false\n    }\n  }\n\n  async #getAdditionalPortfolio(accountId: AccountId, forceUpdate?: boolean) {\n    const rewardsOrGasTankState =\n      this.#latest[accountId]?.rewards || this.#latest[accountId]?.gasTank\n    const canSkipUpdate = rewardsOrGasTankState\n      ? this.#getCanSkipUpdate(rewardsOrGasTankState, forceUpdate)\n      : false\n\n    if (canSkipUpdate) return\n\n    const start = Date.now()\n    const accountState = this.#latest[accountId]\n\n    this.#setNetworkLoading(accountId, 'latest', 'gasTank', true)\n    this.#setNetworkLoading(accountId, 'latest', 'rewards', true)\n    this.emitUpdate()\n\n    let res: any\n    try {\n      res = await this.#callRelayer(`/v2/identity/${accountId}/portfolio-additional`)\n    } catch (e: any) {\n      console.error('relayer error for portfolio additional')\n      this.#setNetworkLoading(accountId, 'latest', 'gasTank', false, e)\n      this.#setNetworkLoading(accountId, 'latest', 'rewards', false, e)\n      this.emitUpdate()\n      return\n    }\n\n    if (!res) throw new Error('portfolio controller: no res, should never happen')\n\n    const rewardsTokens = [\n      res.data.rewards.stkWalletClaimableBalance || [],\n      res.data.rewards.walletClaimableBalance || []\n    ]\n      .flat()\n      .map((t: any) => ({\n        ...t,\n        chainId: BigInt(t.chainId || 1),\n        symbol: t.address === STK_WALLET ? 'stkWALLET' : t.symbol,\n        flags: getFlags(res.data.rewards, 'rewards', t.chainId, t.address)\n      }))\n\n    accountState.rewards = {\n      isReady: true,\n      isLoading: false,\n      errors: [],\n      result: {\n        ...res.data.rewards,\n        lastSuccessfulUpdate: Date.now(),\n        updateStarted: start,\n        tokens: rewardsTokens,\n        total: getTotal(rewardsTokens)\n      }\n    }\n\n    const gasTankTokens: GasTankTokenResult[] = res.data.gasTank.balance.map((t: any) => ({\n      ...t,\n      amount: BigInt(t.amount || 0),\n      chainId: BigInt(t.chainId || 1),\n      availableAmount: BigInt(t.availableAmount || 0),\n      cashback: BigInt(t.cashback || 0),\n      saved: BigInt(t.saved || 0),\n      flags: getFlags(res.data, 'gasTank', t.chainId, t.address)\n    }))\n\n    accountState.gasTank = {\n      isReady: true,\n      isLoading: false,\n      errors: [],\n      result: {\n        updateStarted: start,\n        lastSuccessfulUpdate: Date.now(),\n        tokens: [],\n        gasTankTokens,\n        total: getTotal(gasTankTokens)\n      }\n    }\n\n    this.emitUpdate()\n  }\n\n  #getCanSkipUpdate(\n    networkState?: NetworkState,\n    forceUpdate?: boolean,\n    maxDataAgeMs: number = this.#minUpdateInterval\n  ) {\n    const hasImportantErrors = networkState?.errors.some((e) => e.level === 'critical')\n\n    if (forceUpdate || !networkState || networkState.criticalError || hasImportantErrors)\n      return false\n    const updateStarted = networkState.result?.updateStarted || 0\n    const isWithinMinUpdateInterval = !!updateStarted && Date.now() - updateStarted < maxDataAgeMs\n\n    return isWithinMinUpdateInterval || networkState.isLoading\n  }\n\n  // By our convention, we always stick with private (#) instead of protected methods.\n  // However, we made a compromise here to allow Jest tests to mock updatePortfolioState.\n  protected async updatePortfolioState(\n    accountId: string,\n    network: Network,\n    portfolioLib: Portfolio,\n    portfolioProps: Partial<GetOptions> & { blockTag: 'latest' | 'pending' },\n    forceUpdate: boolean,\n    maxDataAgeMs?: number\n  ): Promise<boolean> {\n    const blockTag = portfolioProps.blockTag\n    const stateKeys = {\n      latest: this.#latest,\n      pending: this.#pending\n    }\n    const accountState = stateKeys[blockTag][accountId]\n    if (!accountState[network.chainId.toString()]) {\n      // isLoading must be false here, otherwise canSkipUpdate will return true\n      // and portfolio will not be updated\n      accountState[network.chainId.toString()] = { isLoading: false, isReady: false, errors: [] }\n    }\n    const canSkipUpdate = this.#getCanSkipUpdate(\n      accountState[network.chainId.toString()],\n      forceUpdate,\n      maxDataAgeMs\n    )\n\n    if (canSkipUpdate) return false\n\n    this.#setNetworkLoading(accountId, blockTag, network.chainId.toString(), true)\n    this.emitUpdate()\n\n    const state = accountState[network.chainId.toString()]!\n    const hasNonZeroTokens = !!Object.values(\n      this.#networksWithAssetsByAccounts?.[accountId] || {}\n    ).some(Boolean)\n\n    try {\n      const result = await portfolioLib.get(accountId, {\n        priceRecency: 60000,\n        priceCache: state.result?.priceCache,\n        fetchPinned: !hasNonZeroTokens,\n        ...portfolioProps\n      })\n\n      const hasError = result.errors.some((e) => e.level !== 'silent')\n      const additionalHintsErc20Hints = portfolioProps.additionalErc20Hints || []\n      let lastSuccessfulUpdate =\n        accountState[network.chainId.toString()]?.result?.lastSuccessfulUpdate || 0\n\n      // Reset lastSuccessfulUpdate on forceUpdate in case of critical errors as the user\n      // is likely expecting a change in the portfolio.\n      if (forceUpdate && hasError) {\n        lastSuccessfulUpdate = 0\n      } else if (!hasError) {\n        // Update the last successful update only if there are no critical errors.\n        lastSuccessfulUpdate = Date.now()\n      }\n\n      const processedTokens = processTokens(\n        result.tokens,\n        network,\n        hasNonZeroTokens,\n        additionalHintsErc20Hints,\n        this.tokenPreferences,\n        this.customTokens\n      )\n\n      accountState[network.chainId.toString()] = {\n        // We cache the previously simulated AccountOps\n        // in order to compare them with the newly passed AccountOps before executing a new updatePortfolioState.\n        // This allows us to identify any differences between the two.\n        accountOps: portfolioProps?.simulation?.accountOps,\n        isReady: true,\n        isLoading: false,\n        errors: result.errors,\n        result: {\n          ...result,\n          lastSuccessfulUpdate,\n          tokens: processedTokens,\n          total: getTotal(processedTokens)\n        }\n      }\n\n      this.emitUpdate()\n      return true\n    } catch (e: any) {\n      this.emitError({\n        level: 'silent',\n        message: \"Error while executing the 'get' function in the portfolio library.\",\n        error: e\n      })\n      state.isLoading = false\n      // Convert the error to an object because the portfolio state is cloned\n      // using structuredClone() which doesn't preserve custom error properties\n      // like simulationErrorMsg\n      state.criticalError = {\n        message: e?.message || 'Error while executing the get function in the portfolio library.',\n        simulationErrorMsg: e?.simulationErrorMsg,\n        stack: e?.stack,\n        name: e?.name\n      }\n\n      if (forceUpdate && state.result) {\n        // Reset lastSuccessfulUpdate on forceUpdate in case of a critical error as the user\n        // is likely expecting a change in the portfolio.\n        state.result.lastSuccessfulUpdate = 0\n      }\n      this.emitUpdate()\n\n      return false\n    }\n  }\n\n  // NOTE: we always pass in all `accounts` and `networks` to ensure that the user of this\n  // controller doesn't have to update this controller every time that those are updated\n\n  // The recommended behavior of the application that this API encourages is:\n  // 1) when the user selects an account, update it's portfolio on all networks (latest state only) by calling updateSelectedAccount\n  // 2) every time the user has a change in their pending (to be signed or to be mined) bundle(s) on a\n  // certain network, call updateSelectedAccount again with those bundles; it will update the portfolio balance\n  // on each network where there are bundles, and it will update both `latest` and `pending` states on said networks\n  // it will also use a high `priceRecency` to make sure we don't lose time in updating prices (since we care about running the simulations)\n\n  // the purpose of this function is to call it when an account is selected or the queue of accountOps changes\n  async updateSelectedAccount(\n    accountId: AccountId,\n    network?: Network,\n    simulation?: {\n      accountOps: { [key: string]: AccountOp[] }\n      states: { [chainId: string]: AccountOnchainState }\n    },\n    opts?: { forceUpdate?: boolean; maxDataAgeMs?: number }\n  ) {\n    await this.#initialLoadPromise\n    const selectedAccount = this.#accounts.accounts.find((x) => x.addr === accountId)\n    if (!selectedAccount) throw new Error('selected account does not exist')\n    if (!this.#latest[accountId]) this.#latest[accountId] = {}\n    if (!this.#pending[accountId]) this.#pending[accountId] = {}\n\n    const accountState = this.#latest[accountId]\n    const pendingState = this.#pending[accountId]\n\n    const updateAdditionalPortfolioIfNeeded =\n      isSmartAccount(selectedAccount) || canBecomeSmarter(selectedAccount, this.#keystore.keys)\n        ? this.#getAdditionalPortfolio(accountId, opts?.forceUpdate)\n        : Promise.resolve()\n\n    const networks = network ? [network] : this.#networks.networks\n    await Promise.all([\n      updateAdditionalPortfolioIfNeeded,\n      ...networks.map(async (network) => {\n        const key = `${network.chainId}:${accountId}`\n\n        const portfolioLib = this.initializePortfolioLibIfNeeded(\n          accountId,\n          network.chainId,\n          network\n        )\n\n        const currentAccountOps = simulation?.accountOps[network.chainId.toString()]?.filter(\n          (op) => op.accountAddr === accountId\n        )\n        const state = simulation?.states?.[network.chainId.toString()]\n        const simulatedAccountOps = pendingState[network.chainId.toString()]?.accountOps\n\n        if (!this.#queue?.[accountId]?.[network.chainId.toString()])\n          this.#queue[accountId] = {\n            ...this.#queue[accountId],\n            [network.chainId.toString()]: Promise.resolve()\n          }\n\n        const updatePromise = async (): Promise<void> => {\n          // We are performing the following extended check because both (or one of both) variables may have an undefined value.\n          // If both variables contain AccountOps, we can simply compare for changes in the AccountOps intent.\n          // However, when one of the variables is not set, two cases arise:\n          // 1. A change occurs if one variable is undefined and the other one holds an AccountOps object.\n          // 2. No change occurs if both variables are undefined.\n          const areAccountOpsChanged =\n            currentAccountOps && simulatedAccountOps\n              ? !isAccountOpsIntentEqual(currentAccountOps, simulatedAccountOps)\n              : currentAccountOps !== simulatedAccountOps\n          const forceUpdate = opts?.forceUpdate || areAccountOpsChanged\n\n          const previousHintsFromExternalAPI = this.#previousHints?.fromExternalAPI?.[key]\n\n          const additionalErc20Hints = [\n            ...Object.keys(\n              (this.#previousHints?.learnedTokens &&\n                this.#previousHints?.learnedTokens[network.chainId.toString()]) ??\n                {}\n            ),\n            ...((this.#toBeLearnedTokens && this.#toBeLearnedTokens[network.chainId.toString()]) ??\n              []),\n            ...this.customTokens\n              .filter(\n                ({ chainId, standard }) => chainId === network.chainId && standard === 'ERC20'\n              )\n              .map(({ address }) => address),\n            // We have to add the token preferences to ensure that the user can always see all hidden tokens\n            // in settings, regardless of the selected account\n            ...this.tokenPreferences\n              .filter(({ chainId }) => chainId === network.chainId)\n              .map(({ address }) => address)\n          ]\n          // TODO: Add custom ERC721 tokens to the hints\n          const additionalErc721Hints = Object.fromEntries(\n            Object.entries(\n              this.#previousHints?.learnedNfts?.[network.chainId.toString()] || {}\n            ).map(([k, v]) => [\n              getAddress(k),\n              { isKnown: false, tokens: v.map((i) => i.toString()) }\n            ])\n          )\n          const allHints = {\n            previousHintsFromExternalAPI,\n            additionalErc20Hints,\n            additionalErc721Hints\n          }\n\n          const [isSuccessfulLatestUpdate] = await Promise.all([\n            // Latest state update\n            this.updatePortfolioState(\n              accountId,\n              network,\n              portfolioLib,\n              {\n                blockTag: 'latest',\n                ...allHints\n              },\n              forceUpdate,\n              opts?.maxDataAgeMs\n            ),\n            this.updatePortfolioState(\n              accountId,\n              network,\n              portfolioLib,\n              {\n                blockTag: 'pending',\n                ...(currentAccountOps &&\n                  state && {\n                    simulation: {\n                      account: selectedAccount,\n                      accountOps: currentAccountOps,\n                      state\n                    }\n                  }),\n                ...allHints\n              },\n              forceUpdate,\n              opts?.maxDataAgeMs\n            )\n          ])\n\n          // Persist latest state in previousHints in the disk storage for further requests\n          if (\n            isSuccessfulLatestUpdate &&\n            !areAccountOpsChanged &&\n            accountState[network.chainId.toString()]?.result\n          ) {\n            const networkResult = accountState[network.chainId.toString()]!.result\n            const readyToLearnTokens = getTokensReadyToLearn(\n              this.#toBeLearnedTokens[network.chainId.toString()],\n              networkResult!.tokens\n            )\n\n            if (readyToLearnTokens.length) {\n              await this.learnTokens(readyToLearnTokens, network.chainId)\n            }\n\n            // Either a valid response or there is no external API to fetch hints from\n            const isExternalHintsApiResponseValid =\n              !!networkResult?.hintsFromExternalAPI || !network.hasRelayer\n\n            if (isExternalHintsApiResponseValid) {\n              const updatedStoragePreviousHints = getUpdatedHints(\n                networkResult!.hintsFromExternalAPI || null,\n                networkResult!.tokens,\n                networkResult!.tokenErrors,\n                network.chainId,\n                this.#previousHints,\n                key,\n                this.customTokens,\n                this.tokenPreferences\n              )\n\n              // Updating hints is only needed when the external API response is valid.\n              // learnTokens and learnNfts update storage separately, so we don't need to update them here\n              // if the external API response is invalid.\n              this.#previousHints = updatedStoragePreviousHints\n              await this.#storage.set('previousHints', updatedStoragePreviousHints)\n            }\n          }\n        }\n\n        // Chain the new updatePromise to the current queue\n        this.#queue[accountId][network.chainId.toString()] = this.#queue[accountId][\n          network.chainId.toString()\n        ]\n          .then(updatePromise)\n          .catch(() => updatePromise())\n\n        // Ensure the method waits for the entire queue to resolve\n        await this.#queue[accountId][network.chainId.toString()]\n      })\n    ])\n\n    await this.#updateNetworksWithAssets(accountId, accountState)\n    this.emitUpdate()\n  }\n\n  markSimulationAsBroadcasted(accountId: string, chainId: bigint) {\n    const simulation = this.#pending[accountId][chainId.toString()]?.accountOps?.[0]\n\n    if (!simulation) return\n\n    simulation.status = AccountOpStatus.BroadcastedButNotConfirmed\n\n    this.emitUpdate()\n  }\n\n  addTokensToBeLearned(tokenAddresses: string[], chainId: bigint) {\n    if (!tokenAddresses.length) return false\n    if (!this.#toBeLearnedTokens[chainId.toString()])\n      this.#toBeLearnedTokens[chainId.toString()] = []\n\n    let networkToBeLearnedTokens = this.#toBeLearnedTokens[chainId.toString()]\n\n    const alreadyLearned = networkToBeLearnedTokens.map((addr) => getAddress(addr))\n\n    const tokensToLearn = tokenAddresses.filter((address) => {\n      let normalizedAddress\n      try {\n        normalizedAddress = getAddress(address)\n      } catch (e) {\n        console.error('Error while normalizing token address', e)\n      }\n\n      return normalizedAddress && !alreadyLearned.includes(normalizedAddress)\n    })\n\n    if (!tokensToLearn.length) return false\n\n    networkToBeLearnedTokens = [...tokensToLearn, ...networkToBeLearnedTokens]\n\n    this.#toBeLearnedTokens[chainId.toString()] = networkToBeLearnedTokens\n    return true\n  }\n\n  // Learn new tokens from humanizer and debug_traceCall\n  // return: whether new tokens have been learned\n  async learnTokens(tokenAddresses: string[] | undefined, chainId: bigint): Promise<boolean> {\n    if (!tokenAddresses) return false\n\n    if (!this.#previousHints.learnedTokens) this.#previousHints.learnedTokens = {}\n\n    let networkLearnedTokens: PreviousHintsStorage['learnedTokens'][''] =\n      this.#previousHints.learnedTokens[chainId.toString()] || {}\n\n    const alreadyLearned = Object.keys(networkLearnedTokens).map((addr) => getAddress(addr))\n\n    const tokensToLearn = tokenAddresses.reduce((acc: { [key: string]: null }, address) => {\n      if (address === ZeroAddress) return acc\n      if (alreadyLearned.includes(getAddress(address))) return acc\n\n      acc[address] = acc[address] || null // Keep the timestamp of all learned tokens\n      return acc\n    }, {})\n\n    if (!Object.keys(tokensToLearn).length) return false\n    // Add new tokens in the beginning of the list\n    networkLearnedTokens = { ...tokensToLearn, ...networkLearnedTokens }\n\n    // Reached limit\n    if (LEARNED_TOKENS_NETWORK_LIMIT - Object.keys(networkLearnedTokens).length < 0) {\n      // Convert learned tokens into an array of [address, timestamp] pairs and sort by timestamp in descending order.\n      // This ensures that tokens with the most recent timestamps are prioritized for retention,\n      // and tokens with the oldest timestamps are deleted last when the limit is exceeded.\n      const learnedTokensArray = Object.entries(networkLearnedTokens).sort(\n        (a, b) => Number(b[1]) - Number(a[1])\n      )\n\n      networkLearnedTokens = Object.fromEntries(\n        learnedTokensArray.slice(0, LEARNED_TOKENS_NETWORK_LIMIT)\n      )\n    }\n\n    this.#previousHints.learnedTokens[chainId.toString()] = networkLearnedTokens\n    await this.#storage.set('previousHints', this.#previousHints)\n    return true\n  }\n\n  async learnNfts(nftsData: [string, bigint[]][] | undefined, chainId: bigint): Promise<boolean> {\n    if (!nftsData?.length) return false\n    if (!this.#previousHints.learnedNfts) this.#previousHints.learnedNfts = {}\n    const networkLearnedNfts: PreviousHintsStorage['learnedNfts'][''] =\n      this.#previousHints.learnedNfts[chainId.toString()] || {}\n\n    const newAddrToId = nftsData.map(([addr, ids]) => ids.map((id) => `${addr}:${id}`)).flat()\n    const alreadyLearnedAddrToId = Object.entries(networkLearnedNfts)\n      .map(([addr, ids]) => ids.map((id) => `${addr}:${id}`))\n      .flat()\n    if (newAddrToId.every((i) => alreadyLearnedAddrToId.includes(i))) return false\n    nftsData.forEach(([addr, ids]) => {\n      if (addr === ZeroAddress) return\n      if (!networkLearnedNfts[addr]) networkLearnedNfts[addr] = ids\n      else networkLearnedNfts[addr] = Array.from(new Set([...ids, ...networkLearnedNfts[addr]]))\n    })\n\n    this.#previousHints.learnedNfts[chainId.toString()] = networkLearnedNfts\n    await this.#storage.set('previousHints', this.#previousHints)\n    return true\n  }\n\n  removeAccountData(address: Account['addr']) {\n    delete this.#latest[address]\n    delete this.#pending[address]\n    delete this.#networksWithAssetsByAccounts[address]\n\n    this.#networks.networks.forEach((network) => {\n      const key = `${network.chainId}:${address}`\n\n      if (key in this.#previousHints.fromExternalAPI) {\n        delete this.#previousHints.fromExternalAPI[key]\n      }\n      if (key in this.#portfolioLibs) {\n        this.#portfolioLibs.delete(key)\n      }\n    })\n    this.#storage.set('previousHints', this.#previousHints)\n    this.#storage.set('networksWithAssetsByAccount', this.#networksWithAssetsByAccounts)\n\n    this.emitUpdate()\n  }\n\n  getLatestPortfolioState(accountAddr: string) {\n    return this.#latest[accountAddr] || {}\n  }\n\n  getPendingPortfolioState(accountAddr: string) {\n    return this.#pending[accountAddr] || {}\n  }\n\n  getNetworksWithAssets(accountAddr: string) {\n    return this.#networksWithAssetsByAccounts[accountAddr] || []\n  }\n\n  async simulateAccountOp(op: AccountOp): Promise<void> {\n    const account = this.#accounts.accounts.find((acc) => acc.addr === op.accountAddr)!\n    const network = this.#networks.networks.find((net) => net.chainId === op.chainId)!\n    const state = await this.#accounts.getOrFetchAccountOnChainState(op.accountAddr, op.chainId)\n    const noSimulation = isBasicAccount(account, state) && network.rpcNoStateOverride\n    const simulation = !noSimulation\n      ? {\n          accountOps: { [network.chainId.toString()]: [op] },\n          states: await this.#accounts.getOrFetchAccountStates(op.accountAddr)\n        }\n      : undefined\n    return this.updateSelectedAccount(op.accountAddr, network, simulation, { forceUpdate: true })\n  }\n\n  toJSON() {\n    return {\n      ...this,\n      ...super.toJSON()\n    }\n  }\n}\n"]}