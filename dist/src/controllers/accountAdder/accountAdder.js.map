{"version":3,"file":"accountAdder.js","sourceRoot":"","sources":["../../../../src/controllers/accountAdder/accountAdder.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCreate2Address, keccak256 } from 'ethers'\n\nimport ExternalSignerError from '../../classes/ExternalSignerError'\nimport { DEFAULT_ACCOUNT_LABEL } from '../../consts/account'\nimport { PROXY_AMBIRE_ACCOUNT } from '../../consts/deploy'\nimport {\n  HD_PATH_TEMPLATE_TYPE,\n  SMART_ACCOUNT_SIGNER_KEY_DERIVATION_OFFSET\n} from '../../consts/derivation'\nimport {\n  Account,\n  AccountOnchainState,\n  AccountOnPage,\n  AccountWithNetworkMeta,\n  DerivedAccount,\n  DerivedAccountWithoutNetworkMeta,\n  SelectedAccountForImport\n} from '../../interfaces/account'\nimport { Fetch } from '../../interfaces/fetch'\nimport { KeyIterator } from '../../interfaces/keyIterator'\nimport { dedicatedToOneSAPriv, ReadyToAddKeys } from '../../interfaces/keystore'\nimport { Network, NetworkId } from '../../interfaces/network'\nimport {\n  getAccountImportStatus,\n  getBasicAccount,\n  getDefaultAccountPreferences,\n  getEmailAccount,\n  getSmartAccount,\n  isAmbireV1LinkedAccount,\n  isDerivedForSmartAccountKeyOnly,\n  isSmartAccount\n} from '../../libs/account/account'\nimport { getAccountState } from '../../libs/accountState/accountState'\nimport { relayerCall } from '../../libs/relayerCall/relayerCall'\n/* eslint-disable @typescript-eslint/no-floating-promises */\nimport { AccountsController } from '../accounts/accounts'\nimport EventEmitter from '../eventEmitter/eventEmitter'\nimport { KeystoreController } from '../keystore/keystore'\nimport { NetworksController } from '../networks/networks'\nimport { ProvidersController } from '../providers/providers'\n\nexport const DEFAULT_PAGE = 1\nexport const DEFAULT_PAGE_SIZE = 5\nconst DEFAULT_SHOULD_SEARCH_FOR_LINKED_ACCOUNTS = true\nconst DEFAULT_SHOULD_GET_ACCOUNTS_USED_ON_NETWORKS = true\n\n/**\n * Account Adder Controller\n * is responsible for listing accounts that can be selected for adding, and for\n * adding (creating) identity for the smart accounts (if needed) on the Relayer.\n * It uses a KeyIterator interface allow iterating all the keys in a specific\n * underlying store such as a hardware device or an object holding a seed.\n */\nexport class AccountAdderController extends EventEmitter {\n  #callRelayer: Function\n\n  #accounts: AccountsController\n\n  #keystore: KeystoreController\n\n  #networks: NetworksController\n\n  #providers: ProvidersController\n\n  #keyIterator?: KeyIterator | null\n\n  hdPathTemplate?: HD_PATH_TEMPLATE_TYPE\n\n  isInitialized: boolean = false\n\n  isInitializedWithSavedSeed: boolean = false\n\n  shouldSearchForLinkedAccounts = DEFAULT_SHOULD_SEARCH_FOR_LINKED_ACCOUNTS\n\n  shouldGetAccountsUsedOnNetworks = DEFAULT_SHOULD_GET_ACCOUNTS_USED_ON_NETWORKS\n\n  /* This is only the index of the current page */\n  page: number = DEFAULT_PAGE\n\n  /* The number of accounts to be displayed on a single page */\n  pageSize: number = DEFAULT_PAGE_SIZE\n\n  /* State to indicate the page requested fails to load (and the reason why) */\n  pageError: null | string = null\n\n  selectedAccounts: SelectedAccountForImport[] = []\n\n  // Accounts which identity is created on the Relayer (if needed), and are ready\n  // to be added to the user's account list by the Main Controller\n  readyToAddAccounts: Account[] = []\n\n  // The keys for the `readyToAddAccounts`, that are ready to be added to the\n  // user's keystore by the Main Controller\n  readyToAddKeys: ReadyToAddKeys = { internal: [], external: [] }\n\n  // Identity for the smart accounts must be created on the Relayer, this\n  // represents the status of the operation, needed managing UI state\n  addAccountsStatus: 'LOADING' | 'SUCCESS' | 'INITIAL' = 'INITIAL'\n\n  accountsLoading: boolean = false\n\n  linkedAccountsLoading: boolean = false\n\n  networksWithAccountStateError: NetworkId[] = []\n\n  #derivedAccounts: DerivedAccount[] = []\n\n  #linkedAccounts: { account: AccountWithNetworkMeta; isLinked: boolean }[] = []\n\n  // This prevents the recalculation of getters that use accounts during the execution of addAccounts.\n  // Without this, the controller incorrectly identifies newly added accounts as those from a previous session,\n  // leading to unpredictable behavior on the AccountAdderScreen\n  #alreadyImportedAccountsOnControllerInit: Account[] = []\n\n  constructor({\n    accounts,\n    keystore,\n    networks,\n    providers,\n    relayerUrl,\n    fetch\n  }: {\n    accounts: AccountsController\n    keystore: KeystoreController\n    networks: NetworksController\n    providers: ProvidersController\n    relayerUrl: string\n    fetch: Fetch\n  }) {\n    super()\n    this.#accounts = accounts\n    this.#keystore = keystore\n    this.#networks = networks\n    this.#providers = providers\n    this.#callRelayer = relayerCall.bind({ url: relayerUrl, fetch })\n  }\n\n  get accountsOnPage(): AccountOnPage[] {\n    const processedAccounts = this.#derivedAccounts\n      // The displayed (visible) accounts on page should not include the derived\n      // EOA (basic) accounts only used as smart account keys, they should not\n      // be visible nor importable (or selectable).\n      .filter((x) => !isDerivedForSmartAccountKeyOnly(x.index))\n      .flatMap((derivedAccount) => {\n        const associatedLinkedAccounts = this.#linkedAccounts.filter(\n          (linkedAcc) =>\n            !isSmartAccount(derivedAccount.account) &&\n            linkedAcc.account.associatedKeys.includes(derivedAccount.account.addr)\n        )\n\n        const correspondingSmartAccount = this.#derivedAccounts.find(\n          (acc) => isSmartAccount(acc.account) && acc.slot === derivedAccount.slot\n        )\n\n        let accountsToReturn: Omit<AccountOnPage, 'importStatus'>[] = []\n\n        if (!isSmartAccount(derivedAccount.account)) {\n          accountsToReturn.push(derivedAccount)\n\n          const duplicate = associatedLinkedAccounts.find(\n            (linkedAcc) => linkedAcc.account.addr === correspondingSmartAccount?.account?.addr\n          )\n\n          // The derived smart account that matches the relayer's linked account\n          // should not be displayed as linked account. Use this cycle to mark it.\n          if (duplicate) duplicate.isLinked = false\n\n          if (!duplicate && correspondingSmartAccount) {\n            accountsToReturn.push(correspondingSmartAccount)\n          }\n        }\n\n        accountsToReturn = accountsToReturn.concat(\n          associatedLinkedAccounts.map((linkedAcc) => ({\n            ...linkedAcc,\n            slot: derivedAccount.slot,\n            index: derivedAccount.index\n          }))\n        )\n\n        return accountsToReturn\n      })\n\n    const unprocessedLinkedAccounts = this.#linkedAccounts\n      .filter(\n        (linkedAcc) =>\n          !processedAccounts.find(\n            (processedAcc) => processedAcc?.account.addr === linkedAcc.account.addr\n          )\n      )\n      // Use `flatMap` instead of `map` in order to auto remove missing values.\n      // The `flatMap` has a built-in mechanism to flatten the array and remove\n      // null or undefined values (by returning empty array).\n      .flatMap((linkedAcc) => {\n        const correspondingDerivedAccount = this.#derivedAccounts.find((derivedAccount) =>\n          linkedAcc.account.associatedKeys.includes(derivedAccount.account.addr)\n        )\n\n        // The `correspondingDerivedAccount` should always be found, except when\n        // something is wrong with the data we have stored on the Relayer.\n        // The this.#verifyLinkedAndDerivedAccounts() method should have\n        // already emitted an error in that case. Do not emit here, since\n        // this is a getter method (and emitting here is a no-go).\n        if (!correspondingDerivedAccount) return []\n\n        return [\n          {\n            ...linkedAcc,\n            slot: correspondingDerivedAccount.slot,\n            index: correspondingDerivedAccount.index\n          }\n        ]\n      })\n\n    const mergedAccounts = [...processedAccounts, ...unprocessedLinkedAccounts]\n\n    mergedAccounts.sort((a, b) => {\n      const prioritizeAccountType = (item: any) => {\n        if (!isSmartAccount(item.account)) return -1\n        if (item.isLinked) return 1\n\n        return 0\n      }\n\n      return prioritizeAccountType(a) - prioritizeAccountType(b) || a.slot - b.slot\n    })\n\n    return mergedAccounts.map((acc) => ({\n      ...acc,\n      importStatus: getAccountImportStatus({\n        account: acc.account,\n        alreadyImportedAccounts: this.#alreadyImportedAccountsOnControllerInit,\n        keys: this.#keystore.keys,\n        accountsOnPage: mergedAccounts,\n        keyIteratorType: this.#keyIterator?.type\n      })\n    }))\n  }\n\n  async #isKeyIteratorInitializedWithTheSavedSeed() {\n    if (this.#keyIterator?.subType !== 'seed') return false\n\n    if (!this.#keystore.hasKeystoreSavedSeed) return false\n\n    const savedSeed = await this.#keystore.getSavedSeed()\n    if (!savedSeed) return false\n\n    return !!this.#keyIterator?.isSeedMatching?.(savedSeed.seed)\n  }\n\n  async #getInitialHdPathTemplate(defaultHdPathTemplate: HD_PATH_TEMPLATE_TYPE) {\n    if (!this.isInitializedWithSavedSeed) return defaultHdPathTemplate\n\n    const savedSeed = await this.#keystore.getSavedSeed()\n    return savedSeed.hdPathTemplate || defaultHdPathTemplate\n  }\n\n  async init({\n    keyIterator,\n    page,\n    pageSize,\n    hdPathTemplate,\n    shouldSearchForLinkedAccounts = DEFAULT_SHOULD_SEARCH_FOR_LINKED_ACCOUNTS,\n    shouldGetAccountsUsedOnNetworks = DEFAULT_SHOULD_GET_ACCOUNTS_USED_ON_NETWORKS\n  }: {\n    keyIterator: KeyIterator | null\n    page?: number\n    pageSize?: number\n    hdPathTemplate: HD_PATH_TEMPLATE_TYPE\n    shouldSearchForLinkedAccounts?: boolean\n    shouldGetAccountsUsedOnNetworks?: boolean\n  }) {\n    this.#keyIterator = keyIterator\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    this.page = page || DEFAULT_PAGE\n    this.pageSize = pageSize || DEFAULT_PAGE_SIZE\n    this.isInitializedWithSavedSeed = await this.#isKeyIteratorInitializedWithTheSavedSeed()\n    this.hdPathTemplate = await this.#getInitialHdPathTemplate(hdPathTemplate)\n    this.isInitialized = true\n    this.#alreadyImportedAccountsOnControllerInit = this.#accounts.accounts\n    this.shouldSearchForLinkedAccounts = shouldSearchForLinkedAccounts\n    this.shouldGetAccountsUsedOnNetworks = shouldGetAccountsUsedOnNetworks\n\n    this.emitUpdate()\n  }\n\n  get type() {\n    return this.#keyIterator?.type\n  }\n\n  get subType() {\n    return this.#keyIterator?.subType\n  }\n\n  reset() {\n    this.#keyIterator = null\n    this.selectedAccounts = []\n    this.page = DEFAULT_PAGE\n    this.pageSize = DEFAULT_PAGE_SIZE\n    this.hdPathTemplate = undefined\n    this.shouldSearchForLinkedAccounts = DEFAULT_SHOULD_SEARCH_FOR_LINKED_ACCOUNTS\n    this.shouldGetAccountsUsedOnNetworks = DEFAULT_SHOULD_GET_ACCOUNTS_USED_ON_NETWORKS\n\n    this.addAccountsStatus = 'INITIAL'\n    this.#derivedAccounts = []\n    this.#linkedAccounts = []\n    this.readyToAddAccounts = []\n    this.networksWithAccountStateError = []\n    this.readyToAddKeys = { internal: [], external: [] }\n    this.isInitialized = false\n    this.isInitializedWithSavedSeed = false\n\n    this.emitUpdate()\n  }\n\n  async setHDPathTemplate({ hdPathTemplate }: { hdPathTemplate: HD_PATH_TEMPLATE_TYPE }) {\n    this.hdPathTemplate = hdPathTemplate\n\n    // Reset the currently selected accounts, because for the keys of these\n    // accounts, as of v4.32.0, we don't store their hd path. When import\n    // completes, only the latest hd path of the controller is stored.\n    this.selectedAccounts = []\n\n    await this.setPage({ page: DEFAULT_PAGE }) // takes the user back on the first page\n  }\n\n  #getAccountKeys(account: Account, accountsOnPageWithThisAcc: AccountOnPage[]) {\n    // should never happen\n    if (accountsOnPageWithThisAcc.length === 0) {\n      console.error(`accountAdder: account ${account.addr} was not found in the accountsOnPage.`)\n      return []\n    }\n\n    // Case 1: The account is a Basic account\n    const isBasicAcc = !isSmartAccount(account)\n    // The key of the Basic account is the basic account itself\n    if (isBasicAcc) return accountsOnPageWithThisAcc\n\n    // Case 2: The account is a Smart account, but not a linked one\n    const isSmartAccountAndNotLinked =\n      isSmartAccount(account) &&\n      accountsOnPageWithThisAcc.length === 1 &&\n      accountsOnPageWithThisAcc[0].isLinked === false\n\n    if (isSmartAccountAndNotLinked) {\n      // The key of the smart account is the Basic account on the same slot\n      // that is explicitly derived for a smart account key only.\n      const basicAccOnThisSlotDerivedForSmartAccKey = this.#derivedAccounts.find(\n        (a) =>\n          a.slot === accountsOnPageWithThisAcc[0].slot &&\n          !isSmartAccount(a.account) &&\n          isDerivedForSmartAccountKeyOnly(a.index)\n      )\n\n      return basicAccOnThisSlotDerivedForSmartAccKey\n        ? [basicAccOnThisSlotDerivedForSmartAccKey]\n        : []\n    }\n\n    // Case 3: The account is a Smart account and a linked one. For this case,\n    // there could exist multiple keys (basic accounts) found on different slots.\n    const basicAccOnEverySlotWhereThisAddrIsFound = accountsOnPageWithThisAcc\n      .map((a) => a.slot)\n      .flatMap((slot) => {\n        const basicAccOnThisSlot = this.#derivedAccounts.find(\n          (a) =>\n            a.slot === slot &&\n            !isSmartAccount(a.account) &&\n            // The key of the linked account is always the EOA (basic) account\n            // on the same slot that is not explicitly used for smart account keys only.\n            !isDerivedForSmartAccountKeyOnly(a.index)\n        )\n\n        return basicAccOnThisSlot ? [basicAccOnThisSlot] : []\n      })\n\n    return basicAccOnEverySlotWhereThisAddrIsFound\n  }\n\n  selectAccount(_account: Account) {\n    if (!this.isInitialized) return this.#throwNotInitialized()\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    // Needed, because linked accounts could have multiple keys (basic accounts),\n    // and therefore - same linked account could be found on different slots.\n    const accountsOnPageWithThisAcc = this.accountsOnPage.filter(\n      (accOnPage) => accOnPage.account.addr === _account.addr\n    )\n    const accountKeys = this.#getAccountKeys(_account, accountsOnPageWithThisAcc)\n    if (!accountKeys.length)\n      return this.emitError({\n        level: 'major',\n        message: `Selecting ${_account.addr} account failed because the details for this account are missing. Please try again or contact support if the problem persists.`,\n        error: new Error(\n          `Trying to select ${_account.addr} account, but this account was not found in the accountsOnPage or it's keys were not found.`\n        )\n      })\n\n    const nextSelectedAccount = {\n      account: _account,\n      // If the account has more than 1 key, it is for sure linked account,\n      // since Basic accounts have only 1 key and smart accounts with more than\n      // one key present should always be found as linked accounts anyways.\n      isLinked: accountKeys.length > 1,\n      accountKeys: accountKeys.map((a) => ({\n        addr: a.account.addr,\n        slot: a.slot,\n        index: a.index\n      }))\n    }\n\n    const accountExists = this.selectedAccounts.some(\n      (x) => x.account.addr === nextSelectedAccount.account.addr\n    )\n    if (accountExists) {\n      // If the account exists, replace it with the new one, to make sure\n      // the latest data is used. We could add one more sub-step to skip this,\n      // if we do a deep comparison, but that would probably be an overkill.\n      this.selectedAccounts = this.selectedAccounts.map((x) =>\n        x.account.addr === nextSelectedAccount.account.addr ? nextSelectedAccount : x\n      )\n    } else {\n      this.selectedAccounts.push(nextSelectedAccount)\n    }\n\n    this.emitUpdate()\n  }\n\n  deselectAccount(account: Account) {\n    if (!this.isInitialized) return this.#throwNotInitialized()\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    const accIdx = this.selectedAccounts.findIndex((x) => x.account.addr === account.addr)\n\n    if (accIdx !== -1) {\n      this.selectedAccounts = this.selectedAccounts.filter((_, i) => i !== accIdx)\n      this.emitUpdate()\n    } else {\n      return this.emitError({\n        level: 'major',\n        message: 'This account cannot be deselected. Please reload and try again.',\n        error: new Error('accountAdder: account not found. Cannot deselect.')\n      })\n    }\n  }\n\n  /**\n   * For internal keys only! Returns the ready to be added internal (private)\n   * keys of the currently selected accounts.\n   */\n  retrieveInternalKeysOfSelectedAccounts() {\n    if (!this.hdPathTemplate) {\n      this.#throwMissingHdPath()\n      return []\n    }\n\n    if (!this.#keyIterator?.retrieveInternalKeys) {\n      this.#throwMissingKeyIteratorRetrieveInternalKeysMethod()\n      return []\n    }\n\n    return this.#keyIterator?.retrieveInternalKeys(\n      this.selectedAccounts,\n      this.hdPathTemplate,\n      this.#keystore.keys\n    )\n  }\n\n  /**\n   * Prevents requesting the next page before the current one is fully loaded.\n   * This avoids race conditions where the user requests the next page before\n   * linked accounts are fully loaded, causing misleadingly failing `#verifyLinkedAccounts` checks.\n   */\n  get isPageLocked() {\n    return this.accountsLoading || this.linkedAccountsLoading\n  }\n\n  async setPage({ page = this.page }: { page: number }): Promise<void> {\n    if (!this.isInitialized) return this.#throwNotInitialized()\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    this.page = page\n    this.pageError = null\n    this.#derivedAccounts = []\n    this.#linkedAccounts = []\n    this.accountsLoading = true\n    this.networksWithAccountStateError = []\n    this.emitUpdate()\n\n    if (page <= 0) {\n      this.pageError = `Unexpected page was requested (page ${page}). Please try again or contact support for help.`\n      this.page = DEFAULT_PAGE // fallback to the default (initial) page\n      this.emitUpdate()\n      return\n    }\n\n    try {\n      this.#derivedAccounts = await this.#deriveAccounts()\n\n      if (this.#keyIterator?.type === 'internal' && this.#keyIterator?.subType === 'private-key') {\n        const accountsOnPageWithoutTheLinked = this.accountsOnPage.filter((acc) => !acc.isLinked)\n        const usedAccounts = accountsOnPageWithoutTheLinked.filter(\n          (acc) => acc.account.usedOnNetworks.length\n        )\n\n        // If at least one account is used - preselect all accounts on the page\n        // (except the linked ones). Usually there are are two accounts\n        // (since the private key flow gas `pageSize` of 1)\n        if (usedAccounts.length) {\n          accountsOnPageWithoutTheLinked.forEach((acc) => this.selectAccount(acc.account))\n        }\n      }\n    } catch (e: any) {\n      const fallbackMessage = `Failed to retrieve accounts on page ${this.page}. Please try again or contact support for assistance. Error details: ${e?.message}.`\n      this.pageError = e instanceof ExternalSignerError ? e.message : fallbackMessage\n    }\n    this.accountsLoading = false\n    this.emitUpdate()\n\n    await this.#findAndSetLinkedAccounts({\n      accounts: this.#derivedAccounts\n        .filter(\n          (acc) =>\n            // Search for linked accounts to the basic (EOA) accounts only.\n            // Searching for linked accounts to another Ambire smart accounts\n            // is a feature that Ambire is yet to support.\n            !isSmartAccount(acc.account) &&\n            // Skip searching for linked accounts to the derived EOA (basic)\n            // accounts that are used for smart account keys only. They are\n            // solely purposed to manage 1 particular (smart) account,\n            // not at all for linking.\n            !isDerivedForSmartAccountKeyOnly(acc.index)\n        )\n        .map((acc) => acc.account)\n    })\n  }\n\n  /**\n   * Triggers the process of adding accounts via the AccountAdder flow by\n   * creating identity for the smart accounts (if needed) on the Relayer.\n   * Then the `onAccountAdderSuccess` listener in the Main Controller gets\n   * triggered, which uses the `readyToAdd...` properties to further set\n   * the newly added accounts data (like preferences, keys and others)\n   */\n  async addAccounts(\n    accounts: SelectedAccountForImport[] = [],\n    readyToAddKeys: ReadyToAddKeys = { internal: [], external: [] }\n  ) {\n    if (!this.isInitialized) return this.#throwNotInitialized()\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    if (!accounts.length) {\n      return this.emitError({\n        level: 'minor',\n        message:\n          'Trying to add accounts, but no accounts are selected. Please select at least one account.',\n        error: new Error(\n          'accountAdder: requested method `addAccounts`, but the accounts param is empty'\n        )\n      })\n    }\n\n    this.addAccountsStatus = 'LOADING'\n    await this.forceEmitUpdate()\n\n    let newlyCreatedAccounts: Account['addr'][] = []\n    const accountsToAddOnRelayer: SelectedAccountForImport[] = accounts\n      // Identity only for the smart accounts must be created on the Relayer\n      .filter((x) => isSmartAccount(x.account))\n      // Skip creating identity for Ambire v1 smart accounts\n      .filter((x) => !isAmbireV1LinkedAccount(x.account.creation?.factoryAddr))\n\n    if (accountsToAddOnRelayer.length) {\n      const body = accountsToAddOnRelayer.map(({ account }: SelectedAccountForImport) => ({\n        addr: account.addr,\n        ...(account.email ? { email: account.email } : {}),\n        associatedKeys: account.initialPrivileges,\n        creation: {\n          factoryAddr: account.creation!.factoryAddr,\n          salt: account.creation!.salt,\n          baseIdentityAddr: PROXY_AMBIRE_ACCOUNT\n        }\n      }))\n\n      try {\n        const res = await this.#callRelayer('/v2/identity/create-multiple', 'POST', {\n          accounts: body\n        })\n\n        if (!res.success) {\n          throw new Error(res?.message || 'No response received from the Ambire Relayer.')\n        }\n\n        type AccResType = {\n          identity: string\n          status: {\n            created: boolean\n            reason?: string\n          }\n        }\n\n        type BodyType = AccResType[]\n        if (res.body) {\n          newlyCreatedAccounts = (res.body as BodyType)\n            .filter((acc: AccResType) => acc.status.created)\n            .map((acc: AccResType) => acc.identity)\n        }\n      } catch (e: any) {\n        this.emitError({\n          level: 'major',\n          message:\n            'Error when adding accounts on the Ambire Relayer. Please try again later or contact support if the problem persists.',\n          error: new Error(e?.message)\n        })\n\n        this.addAccountsStatus = 'INITIAL'\n        await this.forceEmitUpdate()\n        return\n      }\n    }\n\n    this.readyToAddAccounts = [\n      ...accounts.map((x, i) => {\n        const alreadyImportedAcc = this.#accounts.accounts.find((a) => a.addr === x.account.addr)\n\n        return {\n          ...x.account,\n          // Persist the already imported account preferences on purpose, otherwise,\n          // re-importing the same account via different key type(s) would reset them.\n          preferences: alreadyImportedAcc\n            ? alreadyImportedAcc.preferences\n            : getDefaultAccountPreferences(x.account.addr, this.#accounts.accounts, i),\n          newlyCreated: newlyCreatedAccounts.includes(x.account.addr)\n        }\n      })\n    ]\n    this.readyToAddKeys = readyToAddKeys\n    this.addAccountsStatus = 'SUCCESS'\n    await this.forceEmitUpdate()\n\n    // reset the addAccountsStatus in the next tick to ensure the FE receives the 'SUCCESS' state\n    this.addAccountsStatus = 'INITIAL'\n    await this.forceEmitUpdate()\n  }\n\n  async createAndAddEmailAccount(selectedAccount: SelectedAccountForImport) {\n    const {\n      account: { email },\n      accountKeys: [recoveryKey]\n    } = selectedAccount\n    if (!this.isInitialized) return this.#throwNotInitialized()\n    if (!this.#keyIterator) return this.#throwMissingKeyIterator()\n\n    const keyPublicAddress: string = (await this.#keyIterator.retrieve([{ from: 0, to: 1 }]))[0]\n\n    const emailSmartAccount = await getEmailAccount(\n      {\n        emailFrom: email!,\n        secondaryKey: recoveryKey.addr\n      },\n      keyPublicAddress\n    )\n\n    await this.addAccounts([{ ...selectedAccount, account: { ...emailSmartAccount, email } }])\n  }\n\n  // updates the account adder state so the main ctrl receives the readyToAddAccounts\n  // that should be added to the storage of the app\n  async addExistingEmailAccounts(accounts: Account[]) {\n    // There is no need to call the addAccounts method in order to add that\n    // account to the relayer because this func will be called only for accounts returned\n    // from relayer that only need to be stored in the storage of the app\n    this.readyToAddAccounts = accounts\n    this.addAccountsStatus = 'SUCCESS'\n    this.emitUpdate()\n  }\n\n  removeNetworkData(id: Network['id']) {\n    this.networksWithAccountStateError = this.networksWithAccountStateError.filter((x) => x !== id)\n    this.emitUpdate()\n  }\n\n  async #deriveAccounts(): Promise<DerivedAccount[]> {\n    // Should never happen, because before the #deriveAccounts method gets\n    // called - there is a check if the #keyIterator exists.\n    if (!this.#keyIterator) {\n      console.error('accountAdder: missing keyIterator')\n      return []\n    }\n\n    const accounts: DerivedAccountWithoutNetworkMeta[] = []\n\n    const startIdx = (this.page - 1) * this.pageSize\n    const endIdx = (this.page - 1) * this.pageSize + (this.pageSize - 1)\n\n    const indicesToRetrieve = [\n      { from: startIdx, to: endIdx } // Indices for the basic (EOA) accounts\n    ]\n    // Since v4.31.0, do not retrieve smart accounts for the private key\n    // type. That's because we can't use the common derivation offset\n    // (SMART_ACCOUNT_SIGNER_KEY_DERIVATION_OFFSET), and deriving smart\n    // accounts out of the private key (with another approach - salt and\n    // extra entropy) was creating confusion.\n    const shouldRetrieveSmartAccountIndices = this.#keyIterator.type !== 'private-key'\n    if (shouldRetrieveSmartAccountIndices) {\n      // Indices for the smart accounts.\n      indicesToRetrieve.push({\n        from: startIdx + SMART_ACCOUNT_SIGNER_KEY_DERIVATION_OFFSET,\n        to: endIdx + SMART_ACCOUNT_SIGNER_KEY_DERIVATION_OFFSET\n      })\n    }\n    // Combine the requests for all accounts in one call to the keyIterator.\n    // That's optimization primarily focused on hardware wallets, to reduce the\n    // number of calls to the hardware device. This is important, especially\n    // for Trezor, because it fires a confirmation popup for each call.\n    const combinedBasicAndSmartAccKeys = await this.#keyIterator.retrieve(\n      indicesToRetrieve,\n      this.hdPathTemplate\n    )\n\n    const basicAccKeys = combinedBasicAndSmartAccKeys.slice(0, this.pageSize)\n    const smartAccKeys = combinedBasicAndSmartAccKeys.slice(\n      this.pageSize,\n      combinedBasicAndSmartAccKeys.length\n    )\n\n    const smartAccountsPromises: Promise<DerivedAccountWithoutNetworkMeta | null>[] = []\n    // Replace the parallel getKeys with foreach to prevent issues with Ledger,\n    // which can only handle one request at a time.\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [index, smartAccKey] of smartAccKeys.entries()) {\n      const slot = startIdx + (index + 1)\n\n      // The derived EOA (basic) account which is the key for the smart account\n      const account = getBasicAccount(smartAccKey, this.#accounts.accounts)\n      const indexWithOffset = slot - 1 + SMART_ACCOUNT_SIGNER_KEY_DERIVATION_OFFSET\n      accounts.push({ account, isLinked: false, slot, index: indexWithOffset })\n\n      // Derive the Ambire (smart) account\n      smartAccountsPromises.push(\n        getSmartAccount(\n          [{ addr: smartAccKey, hash: dedicatedToOneSAPriv }],\n          this.#accounts.accounts\n        )\n          .then((smartAccount) => {\n            return { account: smartAccount, isLinked: false, slot, index: slot - 1 }\n          })\n          // If the error isn't caught here and the promise is rejected, Promise.all\n          // will be rejected entirely.\n          .catch(() => {\n            // No need for emitting an error here, because a relevant error is already\n            // emitted in the method #getAccountsUsedOnNetworks\n            return null\n          })\n      )\n    }\n\n    const unfilteredSmartAccountsList = await Promise.all(smartAccountsPromises)\n    const smartAccounts = unfilteredSmartAccountsList.filter(\n      (x) => x !== null\n    ) as DerivedAccountWithoutNetworkMeta[]\n\n    accounts.push(...smartAccounts)\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const [index, basicAccKey] of basicAccKeys.entries()) {\n      const slot = startIdx + (index + 1)\n\n      // The EOA (basic) account on this slot\n      const account = getBasicAccount(basicAccKey, this.#accounts.accounts)\n      accounts.push({ account, isLinked: false, slot, index: slot - 1 })\n    }\n\n    const accountsWithNetworks = await this.#getAccountsUsedOnNetworks({ accounts })\n\n    return accountsWithNetworks\n  }\n\n  // inner func\n  // eslint-disable-next-line class-methods-use-this\n  async #getAccountsUsedOnNetworks({\n    accounts\n  }: {\n    accounts: DerivedAccountWithoutNetworkMeta[]\n  }): Promise<DerivedAccount[]> {\n    if (!this.shouldGetAccountsUsedOnNetworks) {\n      return accounts.map((a) => ({ ...a, account: { ...a.account, usedOnNetworks: [] } }))\n    }\n\n    const accountsObj: { [key: Account['addr']]: DerivedAccount } = Object.fromEntries(\n      accounts.map((a) => [a.account.addr, { ...a, account: { ...a.account, usedOnNetworks: [] } }])\n    )\n\n    const networkLookup: { [key: NetworkId]: Network } = {}\n    this.#networks.networks.forEach((network) => {\n      networkLookup[network.id] = network\n    })\n\n    const promises = Object.keys(this.#providers.providers).map(async (providerKey: NetworkId) => {\n      const network = networkLookup[providerKey]\n      if (network) {\n        const accountState = await getAccountState(\n          this.#providers.providers[providerKey],\n          network,\n          accounts.map((acc) => acc.account)\n        ).catch(() => {\n          console.error('accountAdder: failed to get account state on ', providerKey)\n          if (this.networksWithAccountStateError.includes(providerKey)) return\n          this.networksWithAccountStateError.push(providerKey)\n        })\n\n        if (!accountState) return\n\n        accountState.forEach((acc: AccountOnchainState) => {\n          const isUsedOnThisNetwork =\n            // Known limitation: checks only the native token balance. If this\n            // account has any other tokens than native ones, this check will\n            // fail to detect that the account was used on this network.\n            acc.balance > BigInt(0) ||\n            (acc.isEOA\n              ? acc.nonce > BigInt(0)\n              : // For smart accounts, check for 'isDeployed' instead because in\n                // the erc-4337 scenario many cases might be missed with checking\n                // the `acc.nonce`. For instance, `acc.nonce` could be 0, but user\n                // might be actively using the account. This is because in erc-4337,\n                // we use the entry point nonce. However, detecting the entry point\n                // nonce is also not okay, because for various cases we do not use\n                // sequential nonce - i.e., the entry point nonce could still be 0,\n                // but the account is deployed. So the 'isDeployed' check is the\n                // only reliable way to detect if account is used on network.\n                acc.isDeployed)\n          if (isUsedOnThisNetwork) {\n            accountsObj[acc.accountAddr].account.usedOnNetworks.push(network)\n          }\n        })\n      }\n    })\n\n    await Promise.all(promises)\n\n    const finalAccountsWithNetworksArray = Object.values(accountsObj)\n\n    // Preserve the original order of networks based on usedOnNetworks\n    const sortedAccountsWithNetworksArray = finalAccountsWithNetworksArray.sort((a, b) => {\n      const networkIdsA = a.account.usedOnNetworks.map((network) => network.id)\n      const networkIdsB = b.account.usedOnNetworks.map((network) => network.id)\n      const networkIndexA = this.#networks.networks.findIndex((network) =>\n        networkIdsA.includes(network.id)\n      )\n      const networkIndexB = this.#networks.networks.findIndex((network) =>\n        networkIdsB.includes(network.id)\n      )\n      return networkIndexA - networkIndexB\n    })\n\n    return sortedAccountsWithNetworksArray\n  }\n\n  async #findAndSetLinkedAccounts({ accounts }: { accounts: Account[] }) {\n    if (!this.shouldSearchForLinkedAccounts) return\n\n    if (accounts.length === 0) return\n\n    this.linkedAccountsLoading = true\n    this.emitUpdate()\n\n    const keys = accounts.map((acc) => `keys[]=${acc.addr}`).join('&')\n    const url = `/v2/account-by-key/linked/accounts?${keys}`\n\n    const { data } = await this.#callRelayer(url)\n    const linkedAccounts: { account: Account; isLinked: boolean }[] = Object.keys(\n      data.accounts\n    ).flatMap((addr: string) => {\n      // In extremely rare cases, on the Relayer, the identity data could be\n      // missing in the identities table but could exist in the logs table.\n      // When this happens, the account data will be `null`.\n      const isIdentityDataMissing = !data.accounts[addr]\n      if (isIdentityDataMissing) {\n        // Same error for both cases, because most prob\n        this.emitError({\n          level: 'minor',\n          message: `The address ${addr} is not linked to an Ambire account. Please try again later or contact support if the problem persists.`,\n          error: new Error(\n            `The address ${addr} is not linked to an Ambire account. This could be because the identity data is missing in the identities table but could exist in the logs table.`\n          )\n        })\n\n        return []\n      }\n\n      const { factoryAddr, bytecode, salt, associatedKeys } = data.accounts[addr]\n      // Checks whether the account.addr matches the addr generated from the\n      // factory. Should never happen, but could be a possible attack vector.\n      const isInvalidAddress =\n        getCreate2Address(factoryAddr, salt, keccak256(bytecode)).toLowerCase() !==\n        addr.toLowerCase()\n      if (isInvalidAddress) {\n        const message = `The address ${addr} can't be verified to be a smart account address.`\n        this.emitError({ level: 'minor', message, error: new Error(message) })\n\n        return []\n      }\n\n      const existingAccount = this.#accounts.accounts.find((acc) => acc.addr === addr)\n      return [\n        {\n          account: {\n            addr,\n            associatedKeys: Object.keys(associatedKeys),\n            initialPrivileges: data.accounts[addr].initialPrivilegesAddrs.map((address: string) => [\n              address,\n              // this is a default privilege hex we add on account creation\n              '0x0000000000000000000000000000000000000000000000000000000000000001'\n            ]),\n            creation: {\n              factoryAddr,\n              bytecode,\n              salt\n            },\n            preferences: {\n              label: existingAccount?.preferences.label || DEFAULT_ACCOUNT_LABEL,\n              pfp: existingAccount?.preferences?.pfp || addr\n            }\n          },\n          isLinked: true\n        }\n      ]\n    })\n\n    const linkedAccountsWithNetworks = await this.#getAccountsUsedOnNetworks({\n      accounts: linkedAccounts as any\n    })\n\n    this.#linkedAccounts = linkedAccountsWithNetworks\n    this.#verifyLinkedAccounts()\n\n    this.linkedAccountsLoading = false\n    this.emitUpdate()\n  }\n\n  /**\n   * The corresponding derived account for the linked accounts should always be found,\n   * except when something is wrong with the data we have stored on the Relayer.\n   * Also, could be an attack vector. So indicate to the user that something is wrong.\n   */\n  #verifyLinkedAccounts() {\n    this.#linkedAccounts.forEach((linkedAcc) => {\n      const correspondingDerivedAccount = this.#derivedAccounts.find((derivedAccount) =>\n        linkedAcc.account.associatedKeys.includes(derivedAccount.account.addr)\n      )\n\n      // The `correspondingDerivedAccount` should always be found,\n      // except something is wrong with the data we have stored on the Relayer\n      if (!correspondingDerivedAccount) {\n        this.emitError({\n          level: 'major',\n          message: `Something went wrong with finding the corresponding account in the associated keys of the linked account with address ${linkedAcc.account.addr}. Please start the process again. If the problem persists, contact support.`,\n          error: new Error(\n            `Something went wrong with finding the corresponding account in the associated keys of the linked account with address ${linkedAcc.account.addr}.`\n          )\n        })\n      }\n    })\n  }\n\n  #throwNotInitialized() {\n    this.emitError({\n      level: 'major',\n      message:\n        'Something went wrong with deriving the accounts. Please start the process again. If the problem persists, contact support.',\n      error: new Error(\n        'accountAdder: requested a method of the AccountAdder controller, but the controller was not initialized'\n      )\n    })\n  }\n\n  #throwMissingKeyIterator() {\n    this.emitError({\n      level: 'major',\n      message:\n        'Something went wrong with deriving the accounts. Please start the process again. If the problem persists, contact support.',\n      error: new Error('accountAdder: missing keyIterator')\n    })\n  }\n\n  #throwMissingKeyIteratorRetrieveInternalKeysMethod() {\n    this.emitError({\n      level: 'major',\n      message:\n        'Retrieving internal keys failed. Please try to start the process of selecting accounts again. If the problem persist, please contact support.',\n      error: new Error('accountAdder: missing retrieveInternalKeys method')\n    })\n  }\n\n  #throwMissingHdPath() {\n    this.emitError({\n      level: 'major',\n      message:\n        'The HD path template is missing. Please try to start the process of selecting accounts again. If the problem persist, please contact support.',\n      error: new Error('accountAdder: missing hdPathTemplate')\n    })\n  }\n\n  toJSON() {\n    return {\n      ...this,\n      ...super.toJSON(),\n      // includes the getter in the stringified instance\n      accountsOnPage: this.accountsOnPage,\n      type: this.type,\n      subType: this.subType,\n      isPageLocked: this.isPageLocked\n    }\n  }\n}\n\nexport default AccountAdderController\n"]}